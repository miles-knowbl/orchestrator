name: Distribute

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
      - run: npm test -- --run --passWithNoTests

  deploy-vercel:
    needs: build
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Vercel CLI
        run: npm i -g vercel@latest
      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      - name: Build
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

  deploy-railway:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      - name: Link project
        run: railway link --project "$RAILWAY_PROJECT_ID" --service "$RAILWAY_SERVICE" --environment production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE: ${{ secrets.RAILWAY_SERVICE }}
      - name: Deploy
        run: railway up
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 50

      - name: Detect version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

      - name: Create tarball
        run: |
          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          TARBALL="$REPO_NAME-v${{ steps.version.outputs.version }}.tar.gz"
          tar czf "/tmp/$TARBALL" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env*' \
            --exclude='dist' \
            .
          mv "/tmp/$TARBALL" .
          shasum -a 256 "$TARBALL" > checksums.txt

      - name: Generate changelog
        run: |
          COMMITS=$(git log --oneline --no-decorate -20)
          CHANGELOG=$(echo "$COMMITS" | grep -E '^[a-f0-9]+ (feat|fix|style|chore):' | sed 's/^[a-f0-9]* /- /' | head -15)
          if [ -z "$CHANGELOG" ]; then
            echo "- Various improvements and fixes" > /tmp/changelog.md
          else
            echo "$CHANGELOG" > /tmp/changelog.md
          fi

      - name: Create or update rolling release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          VERSION="${{ steps.version.outputs.version }}"
          TARBALL="$REPO_NAME-v${VERSION}.tar.gz"

          gh release delete latest --yes 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true

          cat > /tmp/release-notes.md << EOF
          ## Quick Start (from tarball)

          \`\`\`bash
          tar xzf $TARBALL
          cd orchestrator
          npm install && npm run build
          npm start
          \`\`\`

          ### Install slash commands

          \`\`\`bash
          cp commands/*.md ~/.claude/commands/
          \`\`\`

          ### Connect Claude Code

          \`\`\`bash
          claude mcp add --transport http orchestrator http://localhost:3002/mcp
          claude
          \`\`\`

          ### What's New

          $(cat /tmp/changelog.md)

          ---

          **Version:** ${VERSION} Â· **Commit:** ${{ github.sha }}
          **Prefer one-command install?** \`curl -fsSL https://raw.githubusercontent.com/miles-knowbl/orchestrator/main/install.sh | bash\`
          EOF

          gh release create latest \
            --title "Latest (v${VERSION})" \
            --notes-file /tmp/release-notes.md \
            "$TARBALL" checksums.txt

  docker:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for Dockerfile
        id: check
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "No Dockerfile found, skipping Docker build"
          fi
      - name: Log in to GHCR
        if: steps.check.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        if: steps.check.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:latest
