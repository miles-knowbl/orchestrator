name: Distribute

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
      - run: npm test -- --run

  deploy-vercel:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.DEPLOY_PLATFORM == 'vercel' }}
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Vercel CLI
        run: npm i -g vercel@latest
      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      - name: Build
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

  deploy-railway:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.DEPLOY_PLATFORM == 'railway' }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Railway CLI
        run: npm i -g @railway/cli
      - name: Deploy
        run: railway up --service ${{ secrets.RAILWAY_SERVICE || '' }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

      - name: Create tarball
        run: |
          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          tar czf "$REPO_NAME-v${{ steps.version.outputs.version }}.tar.gz" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env*' \
            --exclude='dist' \
            .
          shasum -a 256 "$REPO_NAME-v${{ steps.version.outputs.version }}.tar.gz" > checksums.txt

      - name: Create or update rolling release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME=$(basename "$GITHUB_REPOSITORY")
          TARBALL="$REPO_NAME-v${{ steps.version.outputs.version }}.tar.gz"

          # Delete existing "latest" release if it exists
          gh release delete latest --yes 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true

          # Create new "latest" release
          gh release create latest \
            --title "Latest (v${{ steps.version.outputs.version }})" \
            --notes "Rolling release â€” updated on every push to main.

          **Version:** ${{ steps.version.outputs.version }}
          **Commit:** ${{ github.sha }}" \
            "$TARBALL" checksums.txt

  docker:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ hashFiles('Dockerfile') != '' }}
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:latest
