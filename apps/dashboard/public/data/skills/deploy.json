{
  "id": "deploy",
  "name": "deploy",
  "version": "1.0.0",
  "description": "Guides deployment of systems to production environments. Covers deployment strategies, production validation, rollback procedures, and monitoring setup. Completes the engineering loop by bridging the gap between merged code and running production systems.",
  "phase": "SHIP",
  "category": "core",
  "content": "# Deploy\n\nShip code to production safely.\n\n## When to Use\n\n- **After PR merge** — Deploy new system or feature\n- **Hotfix** — Emergency production fix\n- **Rollback** — Revert problematic deployment\n- **Environment promotion** — Move from staging to production\n- **Infrastructure changes** — Deploy configuration or infrastructure\n\n## Reference Requirements\n\n**MUST read before applying this skill:**\n\n| Reference | Why Required |\n|-----------|--------------|\n| `rollback-procedures.md` | How to safely rollback if needed |\n\n**Read if applicable:**\n\n| Reference | When Needed |\n|-----------|-------------|\n| Stack-specific deployment guides | For specific deployment targets |\n\n**Verification:** Ensure DEPLOY.md is produced with rollback procedure documented.\n\n## Required Deliverables\n\n| Deliverable | Location | Condition |\n|-------------|----------|-----------|\n| `DEPLOY.md` | Project root | Always |\n\n## Core Concept\n\nDeployment answers: **\"How do we safely get this code running in production?\"**\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                       DEPLOYMENT PIPELINE                                    │\n│                                                                             │\n│  Code Merged    Build &       Deploy to      Validate      Monitor &       │\n│  to Main    →   Package   →   Production  →  Production →  Observe         │\n│                                                                             │\n│  ┌─────────┐    ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐     │\n│  │  PR     │    │ Docker  │   │  K8s/   │   │  Smoke  │   │ Metrics │     │\n│  │ Merged  │───▶│  Build  │──▶│  ECS    │──▶│  Tests  │──▶│ Alerts  │     │\n│  └─────────┘    └─────────┘   └─────────┘   └─────────┘   └─────────┘     │\n│                                    │              │                         │\n│                                    │    FAIL      │                         │\n│                                    ▼              │                         │\n│                              ┌─────────┐         │                         │\n│                              │Rollback │◀────────┘                         │\n│                              └─────────┘                                    │\n│                                                                             │\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n## Deployment Strategies\n\n### Strategy Comparison\n\n| Strategy | Risk | Rollback Speed | Resource Overhead | Best For |\n|----------|------|----------------|-------------------|----------|\n| **Rolling** | Low | Medium | Low | Standard deploys |\n| **Blue-Green** | Very Low | Fast | High (2x) | Critical services |\n| **Canary** | Very Low | Fast | Medium | High-traffic services |\n| **Recreate** | High | Slow | None | Dev/test environments |\n| **Feature Flag** | Very Low | Instant | None | Gradual rollouts |\n\n### Rolling Deployment\n\nDeploy to instances one at a time:\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                    ROLLING DEPLOYMENT                                        │\n│                                                                             │\n│  Time 0:     [v1] [v1] [v1] [v1]                                           │\n│                                                                             │\n│  Time 1:     [v2] [v1] [v1] [v1]   ← First instance updated                │\n│                                                                             │\n│  Time 2:     [v2] [v2] [v1] [v1]   ← Second instance updated               │\n│                                                                             │\n│  Time 3:     [v2] [v2] [v2] [v1]   ← Third instance updated                │\n│                                                                             │\n│  Time 4:     [v2] [v2] [v2] [v2]   ← All instances updated                 │\n│                                                                             │\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n### Blue-Green Deployment\n\nRun two identical environments, switch traffic:\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                    BLUE-GREEN DEPLOYMENT                                     │\n│                                                                             │\n│  Before:                                                                    │\n│                                                                             │\n│           ┌──────────────┐                                                  │\n│  Traffic ─┤  Blue (v1)   │ ← Active                                        │\n│           └──────────────┘                                                  │\n│           ┌──────────────┐                                                  │\n│           │ Green (idle) │ ← Idle                                          │\n│           └──────────────┘                                                  │\n│                                                                             │\n│  After:                                                                     │\n│                                                                             │\n│           ┌──────────────┐                                                  │\n│           │  Blue (v1)   │ ← Idle (rollback target)                        │\n│           └──────────────┘                                                  │\n│           ┌──────────────┐                                                  │\n│  Traffic ─┤ Green (v2)   │ ← Active                                        │\n│           └──────────────┘                                                  │\n│                                                                             │\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n### Canary Deployment\n\nGradually shift traffic to new version:\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                    CANARY DEPLOYMENT                                         │\n│                                                                             │\n│  Stage 1:   5% traffic to v2                                                │\n│                                                                             │\n│           ┌──────────────┐                                                  │\n│  95% ─────┤  v1 (stable) │                                                  │\n│           └──────────────┘                                                  │\n│           ┌──────────────┐                                                  │\n│  5%  ─────┤ v2 (canary)  │                                                  │\n│           └──────────────┘                                                  │\n│                                                                             │\n│  Stage 2:  25% traffic to v2 (if metrics OK)                                │\n│  Stage 3:  50% traffic to v2 (if metrics OK)                                │\n│  Stage 4: 100% traffic to v2 (if metrics OK)                                │\n│                                                                             │\n│  At any stage: Rollback if errors spike                                     │\n│                                                                             │\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n→ See `references/deployment-strategies.md`\n\n## The Deployment Process\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                    DEPLOYMENT PROCESS                                        │\n│                                                                             │\n│  1. PRE-DEPLOYMENT                                                          │\n│     ├─→ Verify build artifacts exist                                        │\n│     ├─→ Run pre-deployment checks                                           │\n│     ├─→ Notify stakeholders                                                 │\n│     └─→ Create deployment record                                            │\n│                                                                             │\n│  2. DEPLOYMENT                                                              │\n│     ├─→ Apply infrastructure changes (if any)                               │\n│     ├─→ Deploy application                                                  │\n│     ├─→ Run database migrations (if any)                                    │\n│     └─→ Update service configuration                                        │\n│                                                                             │\n│  3. VALIDATION                                                              │\n│     ├─→ Health checks pass                                                  │\n│     ├─→ Smoke tests pass                                                    │\n│     ├─→ Metrics within thresholds                                           │\n│     └─→ No error spikes                                                     │\n│                                                                             │\n│  4. POST-DEPLOYMENT                                                         │\n│     ├─→ Update deployment record                                            │\n│     ├─→ Notify stakeholders                                                 │\n│     ├─→ Monitor for issues                                                  │\n│     └─→ Document any issues                                                 │\n│                                                                             │\n│  5. ROLLBACK (if needed)                                                    │\n│     ├─→ Trigger rollback                                                    │\n│     ├─→ Verify rollback successful                                          │\n│     ├─→ Investigate failure                                                 │\n│     └─→ Document incident                                                   │\n│                                                                             │\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n## Pre-Deployment Checklist\n\n### Required Checks\n\n```markdown\n## Pre-Deployment Checklist\n\n### Build Verification\n- [ ] Build artifacts exist\n- [ ] Docker image tagged and pushed\n- [ ] Version number correct\n- [ ] All tests passed in CI\n\n### Database\n- [ ] Migrations tested in staging\n- [ ] Migrations are reversible\n- [ ] No destructive changes (or approved)\n- [ ] Backup taken (if significant migration)\n\n### Dependencies\n- [ ] All dependent services available\n- [ ] External API changes coordinated\n- [ ] Feature flags configured\n\n### Notifications\n- [ ] Team notified of deployment\n- [ ] Stakeholders aware (if significant)\n- [ ] On-call engineer aware\n\n### Documentation\n- [ ] Changelog updated\n- [ ] Runbook updated (if applicable)\n- [ ] Known issues documented\n```\n\n### Pre-Deployment Commands\n\n```bash\n# Verify build\ndocker pull $REGISTRY/$IMAGE:$VERSION\ndocker inspect $REGISTRY/$IMAGE:$VERSION\n\n# Check staging\ncurl -s https://staging.example.com/health | jq .status\n\n# Notify\nslack-notify \"#deployments\" \"Starting deployment of $SERVICE v$VERSION\"\n\n# Create deployment record\ngh api repos/$REPO/deployments -f ref=$SHA -f environment=production\n```\n\n## Deployment Execution\n\n### Kubernetes Deployment\n\n```bash\n# Update deployment\nkubectl set image deployment/$SERVICE $SERVICE=$IMAGE:$VERSION\n\n# Watch rollout\nkubectl rollout status deployment/$SERVICE --timeout=5m\n\n# Check pods\nkubectl get pods -l app=$SERVICE\n```\n\n### Kubernetes Manifest\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: order-service\nspec:\n  replicas: 3\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 0\n  selector:\n    matchLabels:\n      app: order-service\n  template:\n    metadata:\n      labels:\n        app: order-service\n        version: v1.2.3\n    spec:\n      containers:\n      - name: order-service\n        image: registry.example.com/order-service:v1.2.3\n        ports:\n        - containerPort: 3000\n        readinessProbe:\n          httpGet:\n            path: /health\n            port: 3000\n          initialDelaySeconds: 5\n          periodSeconds: 10\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 3000\n          initialDelaySeconds: 15\n          periodSeconds: 20\n        resources:\n          requests:\n            memory: \"256Mi\"\n            cpu: \"100m\"\n          limits:\n            memory: \"512Mi\"\n            cpu: \"500m\"\n```\n\n### AWS ECS Deployment\n\n```bash\n# Update service\naws ecs update-service \\\n  --cluster production \\\n  --service order-service \\\n  --task-definition order-service:$VERSION \\\n  --desired-count 3\n\n# Wait for stability\naws ecs wait services-stable \\\n  --cluster production \\\n  --services order-service\n```\n\n### Docker Compose (Simple)\n\n```bash\n# Pull new images\ndocker-compose pull\n\n# Deploy with zero downtime\ndocker-compose up -d --no-deps --scale service=2 service\nsleep 30\ndocker-compose up -d --no-deps --scale service=1 service\n```\n\n→ See `references/deployment-commands.md`\n\n## Database Migrations\n\n### Migration Safety Rules\n\n1. **Backward compatible first** — New code must work with old schema\n2. **Forward migration only** — During deploy, not rollback\n3. **Test in staging** — Always run migrations in staging first\n4. **Small batches** — Don't lock tables for long\n5. **Backup first** — For destructive changes\n\n### Safe Migration Patterns\n\n| Change | Safe Approach |\n|--------|---------------|\n| Add column | Add with default or nullable, backfill later |\n| Remove column | Stop using, then remove in later deploy |\n| Rename column | Add new, migrate data, remove old |\n| Add index | CREATE INDEX CONCURRENTLY |\n| Change type | Add new column, migrate, drop old |\n\n### Migration Commands\n\n```bash\n# Check pending migrations\nnpm run db:migrate:status\n\n# Run migrations\nnpm run db:migrate\n\n# Rollback (if needed)\nnpm run db:migrate:rollback\n```\n\n→ See `references/migration-safety.md`\n\n## Production Validation\n\n### Health Checks\n\n```bash\n# Basic health\ncurl -s https://api.example.com/health | jq\n\n# Expected response\n{\n  \"status\": \"healthy\",\n  \"version\": \"1.2.3\",\n  \"uptime\": 123,\n  \"dependencies\": {\n    \"database\": \"healthy\",\n    \"redis\": \"healthy\"\n  }\n}\n```\n\n### Smoke Tests\n\n```bash\n# Run smoke tests against production\nnpm run test:smoke -- --env=production\n\n# Or specific checks\ncurl -s -o /dev/null -w \"%{http_code}\" https://api.example.com/orders\n# Should return 401 (unauthorized, but service is up)\n\ncurl -s https://api.example.com/orders -H \"Authorization: Bearer $TOKEN\" | jq '.data | length'\n# Should return order count\n```\n\n### Metric Validation\n\nCheck key metrics are within thresholds:\n\n| Metric | Warning | Critical | Action |\n|--------|---------|----------|--------|\n| Error rate | >1% | >5% | Rollback |\n| Latency p95 | >500ms | >2000ms | Investigate |\n| CPU | >70% | >90% | Scale up |\n| Memory | >80% | >95% | Investigate |\n\n```bash\n# Query Prometheus\ncurl -s \"http://prometheus:9090/api/v1/query?query=rate(http_requests_total{status=~'5..'}[5m])\"\n\n# Check error rate\nERROR_RATE=$(curl -s ... | jq '.data.result[0].value[1]')\nif (( $(echo \"$ERROR_RATE > 0.05\" | bc -l) )); then\n  echo \"ERROR: Error rate $ERROR_RATE exceeds 5%\"\n  exit 1\nfi\n```\n\n### Validation Checklist\n\n```markdown\n## Post-Deployment Validation\n\n### Immediate (< 5 minutes)\n- [ ] Health endpoint returns healthy\n- [ ] All pods/instances running\n- [ ] No crash loops\n- [ ] Smoke tests pass\n\n### Short-term (5-30 minutes)\n- [ ] Error rate stable\n- [ ] Latency within SLA\n- [ ] No memory leaks\n- [ ] Logs look normal\n\n### Medium-term (30 min - 2 hours)\n- [ ] User reports (if any)\n- [ ] Downstream systems healthy\n- [ ] Background jobs running\n- [ ] Metrics trending normally\n```\n\n→ See `references/validation-checklist.md`\n\n## Rollback Procedures\n\n### When to Rollback\n\n| Signal | Severity | Action |\n|--------|----------|--------|\n| Error rate > 5% | Critical | Immediate rollback |\n| Service unavailable | Critical | Immediate rollback |\n| Data corruption | Critical | Immediate rollback + investigation |\n| Error rate > 1% | Warning | Investigate, consider rollback |\n| Latency > 2x normal | Warning | Investigate, consider rollback |\n| User reports | Varies | Investigate |\n\n### Rollback Commands\n\n#### Kubernetes\n\n```bash\n# Rollback to previous revision\nkubectl rollout undo deployment/$SERVICE\n\n# Rollback to specific revision\nkubectl rollout undo deployment/$SERVICE --to-revision=3\n\n# Check rollout history\nkubectl rollout history deployment/$SERVICE\n```\n\n#### Docker Compose\n\n```bash\n# Pull previous version\ndocker-compose pull\n# (after updating docker-compose.yml to previous tag)\n\n# Or directly specify image\ndocker-compose up -d --no-deps service\n```\n\n#### Blue-Green\n\n```bash\n# Switch traffic back to blue\nkubectl patch service $SERVICE -p '{\"spec\":{\"selector\":{\"version\":\"blue\"}}}'\n```\n\n### Rollback Checklist\n\n```markdown\n## Rollback Checklist\n\n### Before Rollback\n- [ ] Confirm rollback decision with team lead\n- [ ] Note current state and symptoms\n- [ ] Alert stakeholders\n\n### Execute Rollback\n- [ ] Trigger rollback command\n- [ ] Verify rollback in progress\n- [ ] Wait for completion\n\n### After Rollback\n- [ ] Verify service healthy\n- [ ] Verify error rate dropping\n- [ ] Notify stakeholders\n- [ ] Create incident ticket\n- [ ] Begin investigation\n```\n\n→ See `references/rollback-procedures.md`\n\n## Monitoring Setup\n\n### Essential Metrics\n\n| Category | Metrics |\n|----------|---------|\n| **RED** | Rate, Errors, Duration |\n| **USE** | Utilization, Saturation, Errors |\n| **Business** | Orders/min, Revenue, Active users |\n\n### Alerting Rules\n\n```yaml\n# Prometheus alerting rules\ngroups:\n  - name: service-alerts\n    rules:\n      - alert: HighErrorRate\n        expr: rate(http_requests_total{status=~\"5..\"}[5m]) > 0.05\n        for: 2m\n        labels:\n          severity: critical\n        annotations:\n          summary: \"High error rate on {{ $labels.service }}\"\n          \n      - alert: HighLatency\n        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: \"High latency on {{ $labels.service }}\"\n```\n\n### Dashboard Essentials\n\n```markdown\n## Deployment Dashboard\n\n### Top Row - Health\n- Service status (up/down)\n- Error rate (current)\n- Request rate (current)\n\n### Second Row - Trends\n- Error rate (24h)\n- Latency p50/p95/p99 (24h)\n- Request rate (24h)\n\n### Third Row - Resources\n- CPU usage\n- Memory usage\n- Pod/instance count\n\n### Bottom Row - Deployments\n- Deployment annotations\n- Version distribution\n- Recent deployments\n```\n\n→ See `references/monitoring-setup.md`\n\n## Deployment Record\n\nTrack deployments for audit and debugging:\n\n```json\n{\n  \"id\": \"deploy-2024-01-17-001\",\n  \"service\": \"order-service\",\n  \"version\": \"1.2.3\",\n  \"environment\": \"production\",\n  \"deployedAt\": \"2024-01-17T14:30:00Z\",\n  \"deployedBy\": \"agent-001\",\n  \"status\": \"success\",\n  \"duration\": 180,\n  \"previousVersion\": \"1.2.2\",\n  \"changes\": {\n    \"commits\": [\"abc1234\", \"def5678\"],\n    \"prNumber\": 123,\n    \"releaseNotes\": \"Added work order completion flow\"\n  },\n  \"validation\": {\n    \"healthCheck\": \"pass\",\n    \"smokeTests\": \"pass\",\n    \"errorRate\": 0.001,\n    \"latencyP95\": 245\n  },\n  \"rollback\": null\n}\n```\n\n## Relationship to Other Skills\n\n| Skill | Relationship |\n|-------|--------------|\n| `distribute` | Sets up CI/CD pipeline; deploy focuses on production strategies |\n| `loop-controller` | Deploy is final stage before COMPLETE |\n| `code-review` | Creates PR that triggers deploy |\n| `git-workflow` | Manages merge that triggers deploy |\n| `integration-test` | Validates before deploy |\n| `security-audit` | Approves security-sensitive deploys |\n\n**Note:** Use `distribute` to set up the CI/CD pipeline (GitHub Actions, Vercel, tarball releases). Use `deploy` for production deployment strategies (blue-green, canary, rollback procedures, monitoring).\n\n## Documentation Site Deployment (Non-Web Apps)\n\nFor CLI tools, MCP servers, and other non-web applications, the SHIP phase should still deploy a **documentation site** to Vercel (or similar). Users need a browsable reference even when the core product isn't a web application.\n\n### What to Deploy\n\n| Content | Source | Purpose |\n|---------|--------|---------|\n| Installation guide | README.md | How to install |\n| Usage examples | Examples/ or README | How to use |\n| API reference | Generated from source | Complete reference |\n| Changelog | CHANGELOG.md | What changed |\n\n### Documentation Site Structure\n\n```\ndocs/\n├── index.md          # Overview + quick start\n├── installation.md   # Installation methods\n├── usage.md          # Usage guide with examples\n├── api/              # Generated API reference\n├── examples/         # Runnable examples\n└── changelog.md      # Version history\n```\n\n### Vercel Deployment\n\n```bash\n# Install docs framework (e.g., VitePress, Nextra, Docusaurus)\nnpm create vitepress@latest docs\n\n# Configure vercel.json\n{\n  \"buildCommand\": \"npm run docs:build\",\n  \"outputDirectory\": \"docs/.vitepress/dist\"\n}\n\n# Deploy\nvercel --prod\n```\n\n### When to Skip\n\nSkip documentation site deployment only if:\n- Project is internal-only with no external users\n- Documentation exists elsewhere (company wiki)\n- User explicitly opts out\n\n**Default behavior:** Always deploy a docs site unless explicitly skipped.\n\n## Key Principles\n\n**Deploy frequently.** Small, frequent deploys are safer than big-bang releases.\n\n**Automate everything.** Manual steps cause errors.\n\n**Validate thoroughly.** Trust but verify.\n\n**Roll back fast.** When in doubt, roll back.\n\n**Monitor continuously.** Watch metrics after deploy.\n\n**Document decisions.** Record what was deployed and why.\n\n**Ship docs too.** Every project deserves a browsable documentation site.\n\n## Mode-Specific Behavior\n\nDeployment strategy and validation differ by orchestrator mode:\n\n### Greenfield Mode\n\n| Aspect | Behavior |\n|--------|----------|\n| **Scope** | Full deployment pipeline setup |\n| **Approach** | Comprehensive deployment strategy design |\n| **Patterns** | Free choice of deployment strategy |\n| **Deliverables** | Full DEPLOY.md + monitoring setup |\n| **Validation** | Standard smoke test suite |\n| **Constraints** | Minimal - standard deployment risk |\n\n### Brownfield-Polish Mode\n\n| Aspect | Behavior |\n|--------|----------|\n| **Scope** | Gap-specific deployment additions |\n| **Approach** | Extend existing deployment patterns |\n| **Patterns** | Should match existing CI/CD patterns |\n| **Deliverables** | Delta deployment changes |\n| **Validation** | Existing tests + gap-specific validation |\n| **Constraints** | Don't break existing deployment process |\n\n**Polish considerations:**\n- [ ] Deploy process matches existing CI/CD\n- [ ] New features behind feature flags if needed\n- [ ] Existing functionality smoke tested\n- [ ] Gap functionality validated\n- [ ] No breaking changes to existing APIs\n\n### Brownfield-Enterprise Mode\n\n| Aspect | Behavior |\n|--------|----------|\n| **Scope** | Change-specific deployment only |\n| **Approach** | Surgical deployment with canary rollout |\n| **Patterns** | Must conform exactly to existing procedures |\n| **Deliverables** | Change record with rollback documentation |\n| **Validation** | Full regression + change-specific testing |\n| **Constraints** | Requires approval - change window scheduled |\n\n**Enterprise deployment requirements:**\n- Change approval required before deploy\n- Deployment window must be scheduled\n- On-call engineer must be available\n- Rollback tested in staging first\n- Post-deploy monitoring period required\n\n**Enterprise deployment record:**\n```json\n{\n  \"changeId\": \"CHG-12345\",\n  \"approvedBy\": \"change-board\",\n  \"deployWindow\": \"2024-01-17T02:00:00Z\",\n  \"rollbackTested\": true,\n  \"monitoringPeriod\": \"4h\",\n  \"escalationPath\": [\"on-call\", \"team-lead\", \"director\"]\n}\n```\n\n---\n\n## References\n\n- `references/deployment-strategies.md`: Detailed strategy comparison\n- `references/deployment-commands.md`: Platform-specific commands\n- `references/migration-safety.md`: Safe database migration patterns\n- `references/validation-checklist.md`: Comprehensive validation steps\n- `references/rollback-procedures.md`: Emergency rollback guide\n- `references/monitoring-setup.md`: Monitoring configuration",
  "references": [
    {
      "name": "DEPLOY.md",
      "path": "references/DEPLOY.md",
      "content": "# DEPLOY.md Template\n\n## Deployment Checklist: {{system-name}}\n\n### Pre-Deployment\n- [ ] All tests passing\n- [ ] Code review approved\n- [ ] Documentation updated\n- [ ] Version bumped\n- [ ] Changelog updated\n\n### Environment\n- [ ] Environment variables configured\n- [ ] Dependencies installed\n- [ ] Database migrations ready\n- [ ] Secrets configured\n\n### Deployment Steps\n1. {{step-1}}\n2. {{step-2}}\n3. {{step-3}}\n\n### Verification\n- [ ] Service starts successfully\n- [ ] Health check passes\n- [ ] Smoke tests pass\n- [ ] Logs show no errors\n\n### Rollback Plan\nIf deployment fails:\n1. {{rollback-step-1}}\n2. {{rollback-step-2}}\n\n### Post-Deployment\n- [ ] Monitor logs for 15 minutes\n- [ ] Check metrics dashboard\n- [ ] Notify team\n\n---\n\n**Deployed by:** {{agent}}\n**Deployed at:** {{timestamp}}\n**Version:** {{version}}\n"
    },
    {
      "name": "deployment-commands.md",
      "path": "references/deployment-commands.md",
      "content": "# Deployment Commands Reference\n\nPlatform-specific commands for the full deployment lifecycle: pre-checks, deploy, verify, and rollback.\n\n## Pre-Deployment Checks\n\nRun these before every deployment regardless of platform.\n\n```bash\n# Verify clean git state\ngit status --porcelain  # Should be empty\ngit log --oneline -3    # Confirm expected commits\n\n# Run test suite\nnpm test                # or: cargo test, pytest, go test ./...\n\n# Validate build succeeds locally\nnpm run build           # or: cargo build --release, docker build .\n```\n\n## Vercel Deployments\n\n| Action | Command |\n|--------|---------|\n| Deploy preview | `vercel` |\n| Deploy production | `vercel --prod` |\n| List deployments | `vercel ls` |\n| Inspect deployment | `vercel inspect <url>` |\n| View logs | `vercel logs <url>` |\n| Rollback | `vercel rollback` |\n| Set env variable | `vercel env add <name> production` |\n| Promote preview to prod | `vercel promote <deployment-url>` |\n\n### Post-Deploy Verification\n```bash\nvercel ls --limit 1\ncurl -sf https://your-app.vercel.app/api/health | jq .\n```\n\n## Railway Deployments\n\n| Action | Command |\n|--------|---------|\n| Deploy | `railway up` |\n| Deploy specific service | `railway up --service <name>` |\n| View logs | `railway logs` |\n| View logs (follow) | `railway logs --follow` |\n| Open dashboard | `railway open` |\n| Set variable | `railway variables set KEY=value` |\n| Link project | `railway link` |\n| Check status | `railway status` |\n\n### Post-Deploy Verification\n```bash\nrailway status\nrailway logs --limit 50\ncurl -sf https://your-app.up.railway.app/health | jq .\n```\n\n## Docker Deployments\n\n| Action | Command |\n|--------|---------|\n| Build image | `docker build -t app:latest .` |\n| Build with tag | `docker build -t app:$(git rev-parse --short HEAD) .` |\n| Push to registry | `docker push ghcr.io/org/app:latest` |\n| Run container | `docker run -d --name app -p 3000:3000 app:latest` |\n| View logs | `docker logs -f app` |\n| Stop container | `docker stop app` |\n| Inspect health | `docker inspect --format='{{.State.Health.Status}}' app` |\n\n### Docker Compose\n```bash\ndocker compose up -d --build              # Deploy with rebuild\ndocker compose up -d --no-deps --build <service>  # Single service\ndocker compose logs -f <service>          # View logs\n```\n\n## AWS Deployments\n\n### ECS (Fargate)\n```bash\naws ecs register-task-definition --cli-input-json file://task-def.json\naws ecs update-service --cluster <cluster> --service <service> \\\n  --task-definition <family>:<revision>\naws ecs describe-services --cluster <cluster> --services <service> \\\n  --query 'services[0].deployments'\n```\n\n### S3 + CloudFront (Static)\n```bash\naws s3 sync ./dist s3://<bucket> --delete\naws cloudfront create-invalidation --distribution-id <id> --paths \"/*\"\n```\n\n## Emergency Rollback Commands\n\n| Platform | Rollback Command | Time |\n|----------|-----------------|------|\n| Vercel | `vercel rollback` | ~30s |\n| Railway | Redeploy previous commit from dashboard | ~2min |\n| Docker | `docker run -d app:<previous-tag>` | ~10s |\n| K8s | `kubectl rollout undo deployment/<name>` | ~30s |\n| ECS | Update service to previous task definition revision | ~3min |\n| S3/CF | `aws s3 sync s3://<bucket-backup> s3://<bucket>` | ~1min |\n\n### Rollback Verification\n```bash\n# 1. Service is responding\ncurl -sf <health-endpoint> | jq .status\n\n# 2. Confirm rollback version\ncurl -sf <health-endpoint> | jq .version\n\n# 3. Notify team\n# Post in incident channel with: what happened, rollback status, next steps\n```\n\n## GitHub Actions Deploy Trigger\n\n```bash\ngh workflow run deploy.yml -f environment=production  # Trigger deploy\ngh run list --workflow=deploy.yml --limit 3           # Check status\ngh run view <run-id> --log                            # View logs\ngh run cancel <run-id>                                # Cancel deploy\n```\n\n## Post-Deployment Verification Script\n\n```bash\n#!/bin/bash\nURL=\"${1:?Usage: verify.sh <base-url>}\"\nPASS=0; TOTAL=0\n\ncheck() {\n  TOTAL=$((TOTAL + 1))\n  if eval \"$2\" > /dev/null 2>&1; then\n    echo \"PASS: $1\"; PASS=$((PASS + 1))\n  else\n    echo \"FAIL: $1\"\n  fi\n}\n\ncheck \"Health endpoint\" \"curl -sf ${URL}/health\"\ncheck \"HTTP 200 on root\" \"curl -sf -o /dev/null -w '%{http_code}' ${URL} | grep 200\"\ncheck \"Response time < 2s\" \"curl -sf -o /dev/null -w '%{time_total}' ${URL} | awk '{exit (\\$1 > 2)}'\"\ncheck \"Status OK\" \"curl -sf ${URL}/health | jq -e '.status == \\\"ok\\\"'\"\n\necho \"Results: ${PASS}/${TOTAL} passed\"\n[ \"$PASS\" -eq \"$TOTAL\" ] && exit 0 || exit 1\n```\n"
    },
    {
      "name": "deployment-strategies.md",
      "path": "references/deployment-strategies.md",
      "content": "# Deployment Strategies Reference\n\nSelecting the right deployment strategy depends on risk tolerance, infrastructure maturity, and the nature of the change being released.\n\n## Strategy Comparison\n\n| Strategy | Downtime | Risk Level | Rollback Speed | Infrastructure Cost | Best For |\n|----------|----------|------------|----------------|---------------------|----------|\n| Blue-Green | Zero | Low | Instant (<1min) | 2x during deploy | Critical services, major releases |\n| Canary | Zero | Very Low | Fast (1-5min) | +10-20% during deploy | High-traffic services, risky changes |\n| Rolling | Zero | Medium | Moderate (5-15min) | Same | Stateless services, routine deploys |\n| Feature Flags | Zero | Low | Instant | Same | Gradual rollouts, A/B testing |\n| Recreate | Brief | High | Slow (10-30min) | Same | Dev/staging, breaking changes |\n\n## Blue-Green Deployments\n\nRun two identical environments. Route traffic from blue (current) to green (new) once verified.\n\n### Process\n1. Deploy new version to the idle environment (green)\n2. Run smoke tests against green (internal URL)\n3. Switch load balancer / DNS to point to green\n4. Monitor for 15-30 minutes\n5. Decommission old blue environment or keep as rollback target\n\n### Rollback\n```\n# Instant: switch traffic back to blue\n# Vercel: revert to previous deployment\nvercel rollback\n\n# Railway: redeploy previous image\nrailway up --service <service> --image <previous-image>\n\n# AWS ALB: change target group\naws elbv2 modify-listener --listener-arn <arn> \\\n  --default-actions Type=forward,TargetGroupArn=<blue-tg-arn>\n```\n\n### When to Use\n- Database schema is backward-compatible\n- You need instant rollback capability\n- The release is high-stakes (payments, auth)\n\n## Canary Releases\n\nRoute a small percentage of traffic to the new version. Increase gradually if metrics are healthy.\n\n### Typical Ramp Schedule\n\n| Stage | Traffic % | Duration | Gate Criteria |\n|-------|-----------|----------|---------------|\n| 1 | 1% | 15 min | Error rate < 0.1%, p99 < 500ms |\n| 2 | 5% | 30 min | Error rate < 0.5%, p99 < 800ms |\n| 3 | 25% | 1 hour | Error rate < 1%, no alerts |\n| 4 | 50% | 2 hours | All metrics nominal |\n| 5 | 100% | -- | Full rollout |\n\n### Rollback\n- Set canary weight back to 0%\n- All traffic returns to stable version\n- No user-facing impact beyond the canary percentage\n\n### When to Use\n- High-traffic services where even brief full-outage is unacceptable\n- Changes to critical paths (checkout, authentication)\n- Performance-sensitive changes needing real-world validation\n\n## Rolling Updates\n\nReplace instances one at a time. Each new instance must pass health checks before the next is updated.\n\n### Configuration Example (Kubernetes)\n```yaml\nspec:\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 1\n      maxSurge: 1\n  minReadySeconds: 30\n```\n\n### Rollback\n```bash\n# Kubernetes\nkubectl rollout undo deployment/<name>\nkubectl rollout status deployment/<name>\n\n# Docker Swarm\ndocker service update --rollback <service>\n```\n\n### When to Use\n- Stateless services with multiple replicas\n- Routine deployments with low risk\n- When infrastructure cost must stay constant\n\n## Feature Flags\n\nDeploy code to production but control activation separately from deployment.\n\n### Implementation Pattern\n```typescript\n// Simple feature flag check\nif (featureFlags.isEnabled('new-checkout-flow', { userId })) {\n  return renderNewCheckout();\n}\nreturn renderLegacyCheckout();\n```\n\n### Rollout Stages\n\n| Stage | Audience | Purpose |\n|-------|----------|---------|\n| Internal | Team only | Smoke testing in production |\n| Beta | Opted-in users | Early feedback |\n| Percentage | 10% -> 50% -> 100% | Gradual rollout |\n| GA | Everyone | Flag removed, code cleaned up |\n\n### Rollback\n- Toggle flag off -- instant, no deployment needed\n- All users revert to previous behavior immediately\n\n### When to Use\n- Long-running feature development merged to main\n- Features needing business-side control of activation\n- A/B testing or gradual user exposure\n\n## Decision Flowchart\n\n```\nIs the change backward-compatible with current DB schema?\n  NO  --> Use Blue-Green with migration window\n  YES --> Is the service high-traffic (>1k rps)?\n            YES --> Use Canary\n            NO  --> Is instant rollback critical?\n                      YES --> Use Blue-Green or Feature Flags\n                      NO  --> Use Rolling Update\n```\n\n## Common Pitfalls\n\n| Pitfall | Impact | Prevention |\n|---------|--------|------------|\n| No health checks configured | Bad instances receive traffic | Always define readiness + liveness probes |\n| Session affinity ignored | Users lose state mid-deploy | Use external session store or sticky sessions |\n| DB migration not backward-compatible | Blue-green rollback fails | Always make migrations additive first |\n| Feature flag debt | Code complexity grows | Schedule flag cleanup within 2 sprints |\n| Skipping staging validation | Production surprises | Gate production deploy on staging success |\n"
    },
    {
      "name": "migration-safety.md",
      "path": "references/migration-safety.md",
      "content": "# Migration Safety Reference\n\nDatabase migrations are the highest-risk part of most deployments. This reference covers patterns for safe, zero-downtime schema changes and data migrations.\n\n## Migration Safety Checklist\n\n| Check | Notes |\n|-------|-------|\n| Migration tested locally | `npm run migrate` on fresh + existing DB |\n| Migration tested on staging | Applied against staging with production-like data |\n| Backward-compatible with current code | Current code works with new schema |\n| Forward-compatible with new code | New code works with old schema (during rollout) |\n| Rollback migration written and tested | Down migration verified |\n| Large table impact assessed | Tables >1M rows need special handling |\n| Lock duration estimated | No long-held exclusive locks |\n| Backup taken | Point-in-time recovery available |\n| Monitoring dashboards open | DB connections, query latency, error rates |\n\n## Zero-Downtime Migration Patterns\n\n### Pattern 1: Expand and Contract\n\nNever remove or rename in a single step. Use a multi-phase approach.\n\n**Phase 1 - Expand:** Add new column, backfill from old, add sync trigger\n```sql\nALTER TABLE users ADD COLUMN email_address VARCHAR(255);\nUPDATE users SET email_address = email WHERE email_address IS NULL;\n```\n\n**Phase 2 - Migrate Code:** Update application to read/write new column\n\n**Phase 3 - Contract:** Remove old column and trigger after all services updated\n```sql\nALTER TABLE users DROP COLUMN email;\n```\n\n### Pattern 2: Add Column with Default\n\n```sql\n-- PostgreSQL 11+: instant, no table rewrite\nALTER TABLE orders ADD COLUMN status VARCHAR(20) DEFAULT 'pending' NOT NULL;\n\n-- Large tables: add nullable, backfill in batches, then add constraint\nALTER TABLE orders ADD COLUMN status VARCHAR(20);\nUPDATE orders SET status = 'pending' WHERE status IS NULL AND id BETWEEN 1 AND 10000;\n```\n\n### Pattern 3: Create New Table, Migrate Data\n\nFor major structural changes: create new table, dual-write, backfill historical data, switch reads, stop old writes, drop old table after verification.\n\n## Dangerous Operations\n\n| Operation | Risk | Safe Alternative |\n|-----------|------|------------------|\n| `DROP COLUMN` | Breaks running code | Expand-contract pattern |\n| `RENAME COLUMN` | Breaks running code | Add new column, migrate, drop old |\n| `ALTER COLUMN TYPE` | Table lock, possible rewrite | Add new column with new type |\n| `ADD NOT NULL` without default | Fails on existing rows | Add with default, then add constraint |\n| `DROP TABLE` | Data loss | Rename first, drop after verification |\n| `CREATE INDEX` | Locks table (non-concurrent) | `CREATE INDEX CONCURRENTLY` |\n\n## Batch Migration for Large Tables\n\nNever update millions of rows in a single transaction.\n\n```sql\nDO $$\nDECLARE\n  batch_size INT := 5000;\n  affected INT;\nBEGIN\n  LOOP\n    UPDATE orders SET status = 'active'\n    WHERE status IS NULL\n      AND id IN (SELECT id FROM orders WHERE status IS NULL LIMIT batch_size FOR UPDATE SKIP LOCKED);\n    GET DIAGNOSTICS affected = ROW_COUNT;\n    EXIT WHEN affected = 0;\n    PERFORM pg_sleep(0.1);\n    COMMIT;\n  END LOOP;\nEND $$;\n```\n\n## Rollback Strategies\n\n| Scenario | Action | Estimated Time |\n|----------|--------|----------------|\n| New column causing issues | `ALTER TABLE DROP COLUMN` | Seconds |\n| Bad index causing slow queries | `DROP INDEX CONCURRENTLY` | Seconds |\n| Data corruption from migration | Restore from point-in-time backup | 15-60 minutes |\n| New table not working | Drop table, redeploy old code | Minutes |\n| Column rename broke queries | Deploy code fix (old name still exists) | Minutes |\n\n## Testing Migrations\n\n```bash\n# Local: reset and test from scratch\nnpm run db:reset && npm run db:migrate\n\n# Staging: test on production-like data\npg_dump production_db | psql test_db\nnpm run db:migrate\n\n# Dry run: preview changes without committing\nBEGIN;\n-- Run migration SQL\nSELECT COUNT(*) FROM affected_table;\nROLLBACK;\n```\n\n## Migration Monitoring\n\n| Metric | Warning | Critical |\n|--------|---------|----------|\n| Active DB connections | >80% pool | >95% pool |\n| Query latency (p99) | >2x baseline | >5x baseline |\n| Lock wait time | >5 seconds | >30 seconds |\n| Error rate | >0.1% | >1% |\n| Replication lag | >10 seconds | >60 seconds |\n\n## Emergency Procedures\n\n1. **Assess** (30 seconds): Is the issue from schema or code change?\n2. **Code issue**: Rollback application only (fast)\n3. **Schema issue**: Apply pre-tested rollback migration\n4. **Data corruption**: Stop writes, restore from backup, notify stakeholders\n5. **Document**: Update migration testing process with lessons learned\n"
    },
    {
      "name": "monitoring-setup.md",
      "path": "references/monitoring-setup.md",
      "content": "# Monitoring Setup Reference\n\nEffective post-deployment monitoring catches issues before users report them. This covers what to monitor, health checks, alerting, and logging.\n\n## The Four Golden Signals\n\n| Signal | What It Measures | Key Metric |\n|--------|------------------|------------|\n| Latency | Time to serve requests | p50, p95, p99 response time |\n| Traffic | Demand on the system | Requests per second |\n| Errors | Rate of failed requests | 5xx rate, error count |\n| Saturation | Resource utilization | CPU, memory, disk, connections |\n\n## Post-Deploy Metrics (First 30 Minutes)\n\n| Metric | Alert If |\n|--------|----------|\n| Error rate (5xx) | >2x pre-deploy baseline |\n| Response time p99 | >1.5x pre-deploy baseline |\n| Active connections | >2x or <0.5x baseline |\n| CPU utilization | >80% sustained |\n| Memory usage | Increasing trend (leak) |\n| Deployment version | Does not match expected |\n\n## Health Check Endpoints\n\n### Standard Response Format\n```json\n{\n  \"status\": \"ok\",\n  \"version\": \"1.2.3\",\n  \"commit\": \"abc1234\",\n  \"timestamp\": \"2025-01-15T10:30:00Z\",\n  \"checks\": {\n    \"database\": { \"status\": \"ok\", \"latency_ms\": 5 },\n    \"cache\": { \"status\": \"ok\", \"latency_ms\": 2 }\n  }\n}\n```\n\n### Health Check Types\n\n| Type | Path | Purpose | Frequency |\n|------|------|---------|-----------|\n| Liveness | `/healthz` | Process is running | Every 10s |\n| Readiness | `/readyz` | Ready to accept traffic | Every 5s |\n| Deep health | `/health` | All dependencies checked | Every 30s |\n| Startup | `/startupz` | Initial boot complete | Every 5s until pass |\n\n## Alerting Thresholds\n\n### Severity Levels\n\n| Level | Response Time | Who Gets Paged |\n|-------|---------------|----------------|\n| P1 - Critical | Immediate (< 5 min) | On-call engineer |\n| P2 - High | < 30 min | On-call engineer |\n| P3 - Medium | < 4 hours | Team channel |\n| P4 - Low | Next business day | Team channel |\n\n### Recommended Alert Rules\n\n| Alert | Condition | Severity |\n|-------|-----------|----------|\n| Service Down | Health check fails 3 consecutive times | P1 |\n| High Error Rate | 5xx rate > 5% for 5 minutes | P1 |\n| Elevated Error Rate | 5xx rate > 1% for 10 minutes | P2 |\n| High Latency | p99 > 3x baseline for 10 minutes | P2 |\n| Memory Leak | Memory increasing >5%/hour | P3 |\n| Disk Space | >85% used | P3 |\n| Certificate Expiry | < 14 days remaining | P3 |\n\n## Logging Best Practices\n\n### Deployment Event Logs\n\n| Event | Log Level | Key Fields |\n|-------|-----------|------------|\n| Deploy started | INFO | version, environment, deployer |\n| Deploy completed | INFO | version, environment, duration |\n| Deploy failed | ERROR | version, environment, error |\n| Rollback initiated | WARN | from_version, to_version, reason |\n| Health check failed | ERROR | check_name, consecutive_failures |\n| Migration applied | INFO | migration_name, duration, rows_affected |\n\n### Log Retention\n\n| Environment | Retention |\n|-------------|-----------|\n| Production | 90 days (centralized) |\n| Staging | 30 days |\n| Development | 7 days |\n| Audit logs | 1 year+ (immutable storage) |\n\n## Dashboard Setup\n\n### Deploy Dashboard Panels\n\n| Panel | Visualization | Data Source |\n|-------|---------------|-------------|\n| Deploy timeline | Annotations on graphs | CI/CD events |\n| Error rate (pre/post) | Time series with deploy markers | APM / logs |\n| Response time percentiles | Time series (p50, p95, p99) | APM |\n| Current version per instance | Table | Health check endpoints |\n| Recent deploys | Table (version, time, status) | CI/CD |\n\n### Platform-Specific Monitoring\n\n| Platform | Built-in | Recommended Add-on |\n|----------|----------|--------------------|\n| Vercel | Analytics, Logs, Web Vitals | Sentry |\n| Railway | Metrics, Logs | Betterstack or Datadog |\n| AWS ECS | CloudWatch metrics + logs | X-Ray |\n| Kubernetes | Metrics API | Prometheus + Grafana |\n\n## Post-Deploy Monitoring Runbook\n\n1. **T+0 min**: Confirm deploy succeeded (CI/CD green, version endpoint updated)\n2. **T+2 min**: Check error rate is at or below pre-deploy baseline\n3. **T+5 min**: Check latency p99 is within 1.5x baseline\n4. **T+15 min**: Review logs for new error patterns or warnings\n5. **T+30 min**: Confirm resource usage is stable (no memory leak, CPU spike)\n6. **T+60 min**: All-clear -- deploy is considered stable\n7. **If any check fails**: Follow rollback procedure, open incident\n"
    },
    {
      "name": "rollback-procedures.md",
      "path": "references/rollback-procedures.md",
      "content": "# Rollback Procedures\n\nEmergency procedures for reverting deployments.\n\n## Decision Framework\n\n### When to Rollback Immediately\n\n| Condition | Action |\n|-----------|--------|\n| Service completely down | Rollback now |\n| Error rate > 5% | Rollback now |\n| Data corruption detected | Rollback now + freeze writes |\n| Security vulnerability active | Rollback now |\n\n### When to Investigate First\n\n| Condition | Action |\n|-----------|--------|\n| Error rate 1-5% | Investigate 5 min, then decide |\n| Latency spike | Investigate 5 min, then decide |\n| Single endpoint failing | Investigate, may not need full rollback |\n| Intermittent errors | Investigate, may be transient |\n\n### When NOT to Rollback\n\n| Condition | Alternative |\n|-----------|-------------|\n| Database migration applied | Fix forward (rollback could cause data loss) |\n| Minor bug, workaround exists | Hotfix |\n| External service issue | Wait for external fix |\n\n## Rollback Procedures by Platform\n\n### Kubernetes\n\n```bash\n# 1. Check current state\nkubectl get deployment $SERVICE -o wide\nkubectl rollout history deployment/$SERVICE\n\n# 2. Rollback to previous version\nkubectl rollout undo deployment/$SERVICE\n\n# 3. Watch rollback progress\nkubectl rollout status deployment/$SERVICE\n\n# 4. Verify pods are healthy\nkubectl get pods -l app=$SERVICE\nkubectl logs -l app=$SERVICE --tail=50\n\n# 5. Verify service responding\ncurl -s https://api.example.com/health\n```\n\n#### Rollback to Specific Version\n\n```bash\n# List history with versions\nkubectl rollout history deployment/$SERVICE\n\n# Rollback to specific revision\nkubectl rollout undo deployment/$SERVICE --to-revision=5\n```\n\n### Docker Compose\n\n```bash\n# 1. Update docker-compose.yml to previous version\n# Edit image: registry.example.com/service:1.2.2 (was 1.2.3)\n\n# 2. Pull previous image\ndocker-compose pull $SERVICE\n\n# 3. Deploy previous version\ndocker-compose up -d $SERVICE\n\n# 4. Verify\ndocker-compose ps\ndocker-compose logs $SERVICE --tail=50\n```\n\n#### Quick Rollback (Keep Previous Running)\n\n```bash\n# If you haven't removed old containers\ndocker-compose up -d --scale $SERVICE=0\ndocker start ${SERVICE}_previous_container\n```\n\n### AWS ECS\n\n```bash\n# 1. Get previous task definition\naws ecs describe-services --cluster $CLUSTER --services $SERVICE \\\n  --query 'services[0].taskDefinition'\n\n# 2. List task definition revisions\naws ecs list-task-definitions --family-prefix $SERVICE\n\n# 3. Update service to previous task definition\naws ecs update-service \\\n  --cluster $CLUSTER \\\n  --service $SERVICE \\\n  --task-definition $SERVICE:$PREVIOUS_REVISION\n\n# 4. Wait for stability\naws ecs wait services-stable --cluster $CLUSTER --services $SERVICE\n```\n\n### Blue-Green\n\n```bash\n# 1. Identify current active environment\nkubectl get service $SERVICE -o jsonpath='{.spec.selector.version}'\n\n# 2. Switch to other environment\nkubectl patch service $SERVICE -p '{\"spec\":{\"selector\":{\"version\":\"blue\"}}}'\n# or\nkubectl patch service $SERVICE -p '{\"spec\":{\"selector\":{\"version\":\"green\"}}}'\n\n# 3. Verify traffic switched\nkubectl get endpoints $SERVICE\n```\n\n### Canary\n\n```bash\n# 1. Set canary weight to 0\nkubectl patch virtualservice $SERVICE --type merge -p '\nspec:\n  http:\n  - route:\n    - destination:\n        host: $SERVICE\n        subset: stable\n      weight: 100\n    - destination:\n        host: $SERVICE\n        subset: canary\n      weight: 0\n'\n\n# 2. Scale down canary\nkubectl scale deployment $SERVICE-canary --replicas=0\n```\n\n## Database Rollback Considerations\n\n### When Migration is Reversible\n\n```bash\n# 1. Rollback application first\nkubectl rollout undo deployment/$SERVICE\n\n# 2. Then rollback migration\nnpm run db:migrate:rollback\n\n# 3. Verify data integrity\nnpm run db:verify\n```\n\n### When Migration is NOT Reversible\n\nIf migration cannot be rolled back (dropped column, data transformation):\n\n```bash\n# DO NOT rollback migration\n\n# Option 1: Fix forward\n# - Deploy hotfix that works with new schema\n# - Fast-track through pipeline\n\n# Option 2: Feature flag\n# - Disable feature using new schema\n# - Users see old behavior\n# - Fix and re-enable\n\n# Option 3: Partial rollback\n# - Rollback app to version that works with new schema\n# - Not the version before migration\n```\n\n### Data Corruption Response\n\n```bash\n# 1. IMMEDIATELY stop writes\nkubectl scale deployment/$SERVICE --replicas=0\n\n# 2. Assess damage\npsql $DATABASE -c \"SELECT COUNT(*) FROM affected_table WHERE corrupted_flag\"\n\n# 3. Restore from backup if needed\npg_restore -d $DATABASE backup_before_deploy.dump\n\n# 4. Or run data fix script\npsql $DATABASE -f fix_corrupted_data.sql\n\n# 5. Verify fix\nnpm run db:verify\n\n# 6. Resume service\nkubectl scale deployment/$SERVICE --replicas=3\n```\n\n## Communication During Rollback\n\n### Internal Communication\n\n```markdown\n## 🚨 Rollback in Progress\n\n**Service:** order-service\n**Version:** 1.2.3 → 1.2.2\n**Reason:** Error rate spiked to 8%\n**Started:** 2024-01-17 14:45 UTC\n**ETA:** 5 minutes\n\n**Impact:**\n- Order creation may fail intermittently\n- No data loss expected\n\n**Actions:**\n- Rollback initiated by @engineer\n- Monitoring metrics\n- Will update when complete\n```\n\n### Completion Notification\n\n```markdown\n## ✅ Rollback Complete\n\n**Service:** order-service  \n**Rolled back to:** 1.2.2\n**Duration:** 4 minutes\n**Status:** Service healthy\n\n**Metrics:**\n- Error rate: 0.1% (was 8%)\n- Latency p95: 250ms (was 2000ms)\n\n**Next Steps:**\n- Incident ticket: INC-2024-0117\n- RCA scheduled for tomorrow\n- Do not re-deploy 1.2.3 without fix\n```\n\n## Post-Rollback Checklist\n\n```markdown\n## Post-Rollback Checklist\n\n### Immediate (< 5 minutes)\n- [ ] Service health verified\n- [ ] Error rate dropping\n- [ ] Metrics stabilizing\n- [ ] Team notified\n\n### Short-term (< 1 hour)\n- [ ] Incident ticket created\n- [ ] Stakeholders notified\n- [ ] Logs preserved for investigation\n- [ ] Deployment record updated\n\n### Investigation (< 24 hours)\n- [ ] Root cause identified\n- [ ] Fix developed\n- [ ] Fix tested in staging\n- [ ] Deployment plan for fix\n\n### Long-term\n- [ ] RCA completed\n- [ ] Preventive measures identified\n- [ ] Monitoring improved (if needed)\n- [ ] Runbook updated\n```\n\n## Rollback Automation\n\n### Automated Rollback Script\n\n```bash\n#!/bin/bash\n# rollback.sh\n\nSERVICE=$1\nREASON=$2\n\necho \"Starting rollback for $SERVICE\"\necho \"Reason: $REASON\"\n\n# 1. Notify\nslack-notify \"#incidents\" \"🚨 Rolling back $SERVICE: $REASON\"\n\n# 2. Rollback\nkubectl rollout undo deployment/$SERVICE\n\n# 3. Wait\nkubectl rollout status deployment/$SERVICE --timeout=5m\n\n# 4. Verify\nHEALTH=$(curl -s https://api.example.com/health | jq -r .status)\nif [ \"$HEALTH\" != \"healthy\" ]; then\n  echo \"WARNING: Service not healthy after rollback\"\n  slack-notify \"#incidents\" \"⚠️ Rollback complete but service unhealthy\"\n  exit 1\nfi\n\n# 5. Confirm\nslack-notify \"#incidents\" \"✅ Rollback of $SERVICE complete. Service healthy.\"\necho \"Rollback complete\"\n```\n\n### Automated Rollback Trigger\n\n```yaml\n# Prometheus alert that triggers rollback\n- alert: AutoRollbackTrigger\n  expr: rate(http_requests_total{status=~\"5..\"}[2m]) > 0.1\n  for: 2m\n  labels:\n    severity: critical\n    auto_rollback: \"true\"\n  annotations:\n    summary: \"Auto-rollback triggered for {{ $labels.service }}\"\n    runbook: \"https://runbook.example.com/auto-rollback\"\n```\n\n## Emergency Contacts\n\n```markdown\n## Rollback Escalation\n\n### Level 1: On-call Engineer\n- Triggered by: Alert\n- Can do: Standard rollback\n\n### Level 2: Team Lead\n- Escalate when: Rollback fails or data issue\n- Can do: Approve non-standard actions\n\n### Level 3: SRE/Platform Team\n- Escalate when: Infrastructure issue\n- Can do: Platform-level recovery\n\n### Level 4: Management\n- Escalate when: Customer-impacting > 30 min\n- Can do: Approve emergency measures\n```\n"
    },
    {
      "name": "validation-checklist.md",
      "path": "references/validation-checklist.md",
      "content": "# Validation Checklist Reference\n\nSystematic validation before, during, and after deployment reduces incidents. This reference provides checklists for deployment validation across environments.\n\n## Pre-Deployment Validation\n\n### Code Readiness\n\n| Check | Command / Action | Pass Criteria |\n|-------|------------------|---------------|\n| All tests pass | `npm test` | Exit code 0, no skipped tests |\n| Build succeeds | `npm run build` | No errors, output matches expected |\n| Linting clean | `npm run lint` | Zero warnings, zero errors |\n| Type checking passes | `npx tsc --noEmit` | No type errors |\n| No debug code | Search for `console.log`, `debugger` | None in production paths |\n| Dependencies audited | `npm audit` | No critical/high vulnerabilities |\n| Environment variables documented | Review `.env.example` | All new vars documented and set |\n\n### Change Readiness\n\n| Check | Pass Criteria |\n|-------|---------------|\n| PR approved | At least 1 approval, no blocking comments |\n| Staging tested | All critical paths verified |\n| Migration reviewed | Backward-compatible, rollback tested |\n| Feature flags configured | Flags set to correct default state |\n| Rollback plan documented | Clear steps, estimated time, owner |\n\n### Infrastructure Readiness\n\n| Check | Pass Criteria |\n|-------|---------------|\n| Target environment healthy | All services green |\n| Sufficient resources | >30% headroom available |\n| No conflicting deploys | No other team deploying |\n| Backup verified | Point-in-time recovery available |\n| SSL certificates valid | >30 days remaining |\n\n## Post-Deployment Smoke Tests\n\n| Test | Method | Expected Result | Timeout |\n|------|--------|-----------------|---------|\n| Health endpoint | `GET /health` | 200 with `status: ok` | 5s |\n| Homepage loads | `GET /` | 200, key content present | 10s |\n| Authentication works | Login with test account | Session created | 15s |\n| API responds | `GET /api/v1/status` | 200 with valid JSON | 5s |\n| Database connected | Health check includes DB | DB status: ok | 5s |\n| Static assets served | Check CSS/JS loads | 200, correct content-type | 5s |\n\n### Smoke Test Script\n```bash\n#!/bin/bash\nset -euo pipefail\nBASE_URL=\"${1:?Usage: smoke-test.sh <base-url>}\"\nFAILURES=0\n\nsmoke() {\n  local name=\"$1\" url=\"$2\" expected=\"$3\"\n  local status\n  status=$(curl -sf -o /dev/null -w \"%{http_code}\" --max-time 10 \"$url\" 2>/dev/null || echo \"000\")\n  if [ \"$status\" = \"$expected\" ]; then\n    echo \"  PASS  $name (HTTP $status)\"\n  else\n    echo \"  FAIL  $name (expected $expected, got $status)\"\n    FAILURES=$((FAILURES + 1))\n  fi\n}\n\nsmoke \"Health check\" \"$BASE_URL/health\" \"200\"\nsmoke \"Homepage\"     \"$BASE_URL/\"       \"200\"\nsmoke \"API status\"   \"$BASE_URL/api/v1/status\" \"200\"\nsmoke \"404 handling\" \"$BASE_URL/nonexistent\"   \"404\"\n\n[ \"$FAILURES\" -gt 0 ] && echo \"ROLLBACK RECOMMENDED\" && exit 1\necho \"All smoke tests passed\" && exit 0\n```\n\n## Environment-Specific Checks\n\n### Staging\n| Check | Notes |\n|-------|-------|\n| Production-like data present | Anonymized production data or realistic seed |\n| External integrations connected | Sandbox/test credentials for third parties |\n| Performance baseline established | Response times within 2x of production |\n| Migration applied cleanly | Schema matches expected state |\n| Notifications go to test targets | No real users contacted |\n\n### Production\n| Check | Notes |\n|-------|-------|\n| Version endpoint returns new version | Deployment actually applied |\n| Error rate not elevated | Compare to 1-hour pre-deploy baseline |\n| No new error types in logs | Scan for novel error messages |\n| External integrations working | Payments, email, webhooks operational |\n| CDN cache invalidated (if applicable) | Users see new assets |\n\n## Stakeholder Sign-Off\n\n### Pre-Deploy\n\n| Role | Responsibility | Sign-Off Method |\n|------|----------------|-----------------|\n| Engineering Lead | Code quality, architecture | PR approval |\n| QA / Test Lead | Test coverage, staging validation | Test report |\n| Product Owner | Feature completeness | Acceptance in ticket |\n| DBA (if migration) | Migration safety | Migration review approved |\n\n### Post-Deploy\n\n| Role | Confirms | Timeframe |\n|------|----------|-----------|\n| Deploying Engineer | Smoke tests pass, metrics nominal | T+5 minutes |\n| Engineering Lead | No elevated errors | T+30 minutes |\n| Product Owner | Feature works as expected | T+1 hour |\n\n## Incident Response if Validation Fails\n\n### Decision Tree\n```\nSmoke test failed?\n  Single non-critical endpoint --> Log issue, fix forward\n  Error rate > 2x baseline    --> ROLLBACK IMMEDIATELY\n  Fixable in < 15 minutes     --> Hotfix and redeploy\n  Otherwise                   --> ROLLBACK, fix in next deploy\n```\n\n### Rollback Triggers (Immediate)\n\n| Condition | Threshold |\n|-----------|-----------|\n| Service completely down | Health check returning 5xx or timeout |\n| Error rate spike | >5x baseline for >2 minutes |\n| Data integrity risk | Any indication of corrupt writes |\n| Security vulnerability | Exposed credentials, broken auth |\n| Payment processing broken | Any failures above baseline |\n\n### Post-Incident Steps\n\n1. **Stabilize**: Confirm rollback successful, services healthy\n2. **Communicate**: Notify stakeholders of rollback and timeline\n3. **Investigate**: Root cause analysis within 24 hours\n4. **Document**: Incident report with timeline and lessons\n5. **Prevent**: Add test coverage or monitoring for the failure mode\n6. **Re-attempt**: Fix, re-validate in staging, re-deploy with extra monitoring\n"
    }
  ],
  "tags": [
    "shipping",
    "operations",
    "core-workflow"
  ],
  "dependsOn": [
    "code-review"
  ]
}