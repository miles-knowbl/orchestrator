{
  "id": "orchestration",
  "name": "orchestration",
  "version": "1.0.0",
  "description": "Spawn and coordinate sub-agents for parallel module execution. 2-layer system with persistent orchestrator and ephemeral task agents.",
  "phase": "INIT",
  "category": "operations",
  "content": "# 2-Layer Orchestration Skill\n\n> Spawn and coordinate sub-agents for parallel module execution\n\n## Overview\n\nThe 2-layer orchestration system enables a single **Layer 1 Orchestrator** per system to spawn multiple **Layer 2 Agents** that work on different modules in parallel. This is the foundation for autonomous operation.\n\n## Architecture\n\n### Layer 1: System Orchestrator\n- **Persistent** - stays active as long as you're working on the system\n- **Human-facing portal** - the interface you interact with\n- **Strategic decisions** - which modules to work on, in what order\n- **Coordinates agents** - spawns, monitors, handles failures\n\n### Layer 2: Task Agents\n- **Ephemeral** - spawned for a task, terminated on completion\n- **Module-scoped** - each agent works on one module\n- **Isolated** - commits to its own git branch via worktree\n- **Autonomous** - executes loops without human intervention\n\n## Git Worktree Model\n\nEach module gets its own git worktree and branch:\n\n```\nproject/\n├── src/                    ← main branch\n└── .worktrees/\n    ├── auth/               ← branch: module/auth\n    ├── api/                ← branch: module/api\n    └── dashboard/          ← branch: module/dashboard\n```\n\nBenefits:\n- **Isolation** - no merge conflicts during parallel development\n- **Parallel** - multiple agents can work simultaneously\n- **Clean merges** - module completion = merge to main\n\n## MCP Tools\n\n### Orchestrator Management\n| Tool | Description |\n|------|-------------|\n| `init_orchestrator` | Initialize orchestrator for a system |\n| `get_orchestrator` | Get orchestrator state |\n| `pause_orchestrator` | Pause (no new work assigned) |\n| `resume_orchestrator` | Resume paused orchestrator |\n| `shutdown_orchestrator` | Graceful shutdown |\n\n### Agent Management\n| Tool | Description |\n|------|-------------|\n| `spawn_agent` | Spawn single agent for module + loop |\n| `spawn_agents_auto` | Auto-spawn for highest leverage work |\n| `list_agents` | List all agents |\n| `get_agent` | Get agent details |\n| `get_agents_by_module` | Filter agents by module |\n| `terminate_agent` | Terminate an agent |\n\n### Work Queue\n| Tool | Description |\n|------|-------------|\n| `get_work_queue` | View pending/in-progress/completed work |\n| `get_next_work` | Get leverage-scored next items |\n\n### Monitoring\n| Tool | Description |\n|------|-------------|\n| `get_orchestration_progress` | Progress summary |\n| `get_orchestration_events` | Event log |\n| `render_orchestration_terminal` | Terminal visualization |\n\n### Autonomous Execution\n| Tool | Description |\n|------|-------------|\n| `run_autonomous_cycle` | Full cycle: identify → spawn → execute |\n\n## API Endpoints\n\n### Orchestrator\n| Endpoint | Method | Description |\n|----------|--------|-------------|\n| `/api/orchestration/init` | POST | Initialize orchestrator |\n| `/api/orchestration` | GET | Get orchestrator state |\n| `/api/orchestration/pause` | PUT | Pause |\n| `/api/orchestration/resume` | PUT | Resume |\n| `/api/orchestration/shutdown` | PUT | Shutdown |\n\n### Agents\n| Endpoint | Method | Description |\n|----------|--------|-------------|\n| `/api/orchestration/agents` | POST | Spawn agent |\n| `/api/orchestration/agents/auto` | POST | Auto-spawn |\n| `/api/orchestration/agents` | GET | List agents |\n| `/api/orchestration/agents/:id` | GET | Get agent |\n| `/api/orchestration/agents/:id` | DELETE | Terminate agent |\n\n### Work & Monitoring\n| Endpoint | Method | Description |\n|----------|--------|-------------|\n| `/api/orchestration/work-queue` | GET | Work queue |\n| `/api/orchestration/next-work` | GET | Next work items |\n| `/api/orchestration/progress` | GET | Progress summary |\n| `/api/orchestration/events` | GET | Event log |\n| `/api/orchestration/terminal` | GET | Terminal view |\n\n## Concurrency Modes\n\nThe orchestrator automatically selects concurrency mode:\n\n| Mode | When | Use Case |\n|------|------|----------|\n| `sequential` | File overlap or dependencies | Avoid conflicts |\n| `parallel-async` | 2-4 independent tasks | Light parallelism |\n| `parallel-threads` | 5+ tasks | Full parallelism |\n\n## Failure Handling\n\nCascading recovery:\n\n1. **Retry with context** - Agent retries with knowledge of what failed\n2. **Reassign** - Terminate agent, spawn fresh one with failure context\n3. **Escalate** - Last resort, alert human (considered failure toward autonomy)\n\n## Usage Flow\n\n### Initialize\n```typescript\n// Initialize orchestrator for your system\ninit_orchestrator({\n  systemId: \"taste-mixer\",\n  systemPath: \"/Users/you/projects/taste-mixer\"\n})\n```\n\n### Manual Agent Spawn\n```typescript\n// Spawn agent for specific module\nspawn_agent({\n  moduleId: \"auth\",\n  loopId: \"engineering-loop\",\n  scope: \"Implement authentication system\"\n})\n```\n\n### Autonomous Execution\n```typescript\n// Let orchestrator decide what to work on\nrun_autonomous_cycle()\n// Returns: { cycleId, agentsSpawned, modulesTargeted }\n```\n\n### Monitor Progress\n```typescript\n// Get overall progress\nget_orchestration_progress()\n\n// Watch specific agent\nget_agent({ agentId: \"...\" })\n\n// View terminal dashboard\nrender_orchestration_terminal()\n```\n\n## Integration\n\n- **RoadmapService** - Module priorities and dependencies\n- **ExecutionEngine** - Loop execution\n- **LoopComposer** - Loop definitions\n- **MemoryService** - Context and learning\n\n## Configuration\n\nDefault configuration (can be overridden):\n\n```typescript\n{\n  defaultConcurrencyMode: 'parallel-threads',\n  maxParallelAgents: undefined,      // Unlimited\n  defaultMaxRetries: 3,\n  retryDelayMs: 5000,\n  escalationThreshold: 10,\n  worktreesDirectory: '.worktrees',\n  branchPrefix: 'module/',\n  autoMergeOnComplete: false,        // Require human approval\n  heartbeatIntervalMs: 5000,\n  heartbeatTimeoutMs: 30000,\n}\n```\n\n## Data Persistence\n\n```\ndata/orchestrators/{systemId}.json   - Orchestrator state\n.worktrees/{moduleId}/               - Git worktrees\n```",
  "references": [],
  "tags": [
    "orchestration",
    "multi-agent",
    "coordination",
    "autonomous"
  ],
  "dependsOn": []
}