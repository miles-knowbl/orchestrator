{
  "id": "infra-services",
  "name": "infra-services",
  "version": "1.0.0",
  "description": "Configure service layer with lazy singleton initialization, dependency management, and lifecycle hooks.",
  "phase": "IMPLEMENT",
  "category": "infra",
  "content": "# Infra Services\n\nConfigure the service layer with proper initialization and dependency management.\n\n## When to Use\n\n- **New backend** — Setting up the service architecture from scratch\n- **Service layer refactor** — Moving from ad-hoc to structured services\n- **Adding dependencies** — Connecting database, cache, external APIs\n- When you say: \"set up services\", \"service layer\", \"dependency injection\"\n\n## Required Deliverables\n\n| Deliverable | Location | Condition |\n|-------------|----------|-----------|\n| Service definitions | `src/services/` | Always |\n| Service initialization | `src/services/index.ts` | Always |\n\n## Core Concept\n\nService setup answers: **\"How do application components get initialized, connected, and managed?\"**\n\n```\nApp Start → Initialize Services (lazy) → Register Dependencies → Ready to Serve\n```\n\n## Lazy Singleton Pattern\n\n```typescript\n// src/services/index.ts\nlet _db: Database | null = null;\nlet _cache: Cache | null = null;\n\nexport function getDatabase(): Database {\n  if (!_db) {\n    _db = new Database(process.env.DATABASE_URL!);\n  }\n  return _db;\n}\n\nexport function getCache(): Cache {\n  if (!_cache) {\n    _cache = new Cache(process.env.REDIS_URL!);\n  }\n  return _cache;\n}\n```\n\n## Service Registry Pattern\n\n```typescript\n// src/services/registry.ts\ninterface ServiceRegistry {\n  db: Database;\n  cache: Cache;\n  mailer: Mailer;\n}\n\nconst registry: Partial<ServiceRegistry> = {};\n\nexport function register<K extends keyof ServiceRegistry>(\n  name: K,\n  service: ServiceRegistry[K]\n): void {\n  registry[name] = service;\n}\n\nexport function resolve<K extends keyof ServiceRegistry>(\n  name: K\n): ServiceRegistry[K] {\n  const service = registry[name];\n  if (!service) throw new Error(`Service not registered: ${name}`);\n  return service;\n}\n```\n\n## Initialization Order\n\nServices often have dependencies. Initialize in dependency order:\n\n```\n1. Configuration (env vars, config files)\n2. Database connections\n3. Cache connections\n4. External API clients\n5. Business services (depend on above)\n6. HTTP server (depends on everything)\n```\n\n## Graceful Shutdown\n\n```typescript\nprocess.on('SIGTERM', async () => {\n  console.log('Shutting down...');\n  await server.close();\n  await db.end();\n  await cache.quit();\n  process.exit(0);\n});\n```\n\n## Checklist\n\n- [ ] Services initialized lazily (not at import time)\n- [ ] Dependency order documented and enforced\n- [ ] Graceful shutdown handles all connections\n- [ ] Health check verifies all critical services\n- [ ] Environment variables validated at startup\n\n## Relationship to Other Skills\n\n| Skill | Relationship |\n|-------|--------------|\n| `infra-database` | Database is a core service dependency |\n| `scaffold` | Project structure includes services directory |\n| `implement` | Business logic builds on the service layer |\n| `deploy` | Graceful shutdown required for zero-downtime deploys |\n\n## Key Principles\n\n**Lazy initialization.** Don't connect until needed; fail fast when connection fails.\n\n**Explicit dependencies.** No hidden globals; services declare what they need.\n\n**Graceful shutdown.** Always clean up connections on process exit.\n\n**Health checks.** Every service should be verifiable at runtime.",
  "references": [],
  "tags": [
    "infrastructure",
    "services",
    "dependency-injection",
    "singletons",
    "initialization"
  ],
  "dependsOn": [
    "infra-database",
    "scaffold"
  ]
}