{
  "id": "loop-controller",
  "name": "loop-controller",
  "version": "1.0.0",
  "description": "Orchestrates the engineering loop execution. Manages state machine transitions, decides what to do next, handles failures and retries, determines completion, and triggers human handoffs. The 'brain' that runs the autonomous development cycle.",
  "phase": "META",
  "category": "meta",
  "content": "# Loop Controller\n\nThe execution brain of the agentic harness.\n\n## When to Use\n\n- **Starting a system build** â€” Initialize loop state and begin execution\n- **Resuming work** â€” Determine where to continue after cold boot\n- **After any skill completes** â€” Decide what's next\n- **On failure** â€” Determine retry strategy or escalation\n- **At checkpoints** â€” Decide if human approval needed\n\n## Reference Requirements\n\n**MUST read before applying this skill:**\n\n| Reference | Why Required |\n|-----------|--------------|\n| `decision-trees.md` | State transition logic |\n| `gate-procedures.md` | How to handle stage gates |\n\n**Read if applicable:**\n\n| Reference | When Needed |\n|-----------|-------------|\n| `failure-handling.md` | When handling failures/retries |\n| `autonomy-configuration.md` | When configuring autonomy mode |\n| `loop-state-schema.json` | When initializing/updating state |\n\n**Verification:** Ensure loop-state.json is accurate and transitions are valid.\n\n## Required Deliverables\n\n| Deliverable | Location | Condition |\n|-------------|----------|-----------|\n| `loop-state.json` | `domain-memory/{domain}/` | Always (maintained) |\n\n## Core Concept\n\nLoop Controller answers: **\"What should I do next?\"**\n\nIt maintains execution state and makes orchestration decisions so the agent doesn't have to reason about the loop itself â€” just execute the current skill.\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                        LOOP CONTROLLER                                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚\nâ”‚  â”‚                      STATE MACHINE                                   â”‚   â”‚\nâ”‚  â”‚                                                                      â”‚   â”‚\nâ”‚  â”‚  INIT â†’ SCAFFOLD â†’ IMPLEMENT â†’ TEST â†’ VERIFY â†’ VALIDATE â†’          â”‚   â”‚\nâ”‚  â”‚         DOCUMENT â†’ REVIEW â†’ SHIP â†’ COMPLETE                         â”‚   â”‚\nâ”‚  â”‚                                                                      â”‚   â”‚\nâ”‚  â”‚  Any stage can transition to: FAILED â†’ RETRY or BLOCKED             â”‚   â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚\nâ”‚                                                                             â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚\nâ”‚  â”‚                      DECISION ENGINE                                 â”‚   â”‚\nâ”‚  â”‚                                                                      â”‚   â”‚\nâ”‚  â”‚  Current State + Context â†’ Next Action                               â”‚   â”‚\nâ”‚  â”‚                                                                      â”‚   â”‚\nâ”‚  â”‚  â€¢ What skill to invoke?                                             â”‚   â”‚\nâ”‚  â”‚  â€¢ Is human approval needed?                                         â”‚   â”‚\nâ”‚  â”‚  â€¢ Should we retry or escalate?                                      â”‚   â”‚\nâ”‚  â”‚  â€¢ Is the system complete?                                           â”‚   â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Loop State Machine\n\n### States\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                         LOOP STATES                                          â”‚\nâ”‚                                                                             â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚\nâ”‚  â”‚   INIT   â”‚ â”€â”€â”€ Load context, verify prerequisites                        â”‚\nâ”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                               â”‚\nâ”‚       â”‚                                                                     â”‚\nâ”‚       â–¼                                                                     â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚\nâ”‚  â”‚ SCAFFOLD â”‚ â”€â”€â”€ Create project structure, setup config                    â”‚\nâ”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                               â”‚\nâ”‚       â”‚                                                                     â”‚\nâ”‚       â–¼                                                                     â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚\nâ”‚  â”‚IMPLEMENT â”‚â”€â”€â”€â”€â–¶â”‚   TEST   â”‚â”€â”€â”€â”€â–¶â”‚  VERIFY  â”‚ â”€â”€â”€ Per-capability loop    â”‚\nâ”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                            â”‚\nâ”‚       â”‚                â”‚                â”‚                                   â”‚\nâ”‚       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (next capability)                â”‚\nâ”‚       â”‚                                                                     â”‚\nâ”‚       â–¼ (all capabilities done)                                            â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚\nâ”‚  â”‚ VALIDATE â”‚ â”€â”€â”€ Full system validation (security, perf, integration)     â”‚\nâ”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                               â”‚\nâ”‚       â”‚                                                                     â”‚\nâ”‚       â–¼                                                                     â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚\nâ”‚  â”‚ DOCUMENT â”‚ â”€â”€â”€ Generate/update documentation                             â”‚\nâ”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                               â”‚\nâ”‚       â”‚                                                                     â”‚\nâ”‚       â–¼                                                                     â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚\nâ”‚  â”‚  REVIEW  â”‚ â”€â”€â”€ Self-review, prepare PR                                   â”‚\nâ”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                               â”‚\nâ”‚       â”‚                                                                     â”‚\nâ”‚       â–¼                                                                     â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚\nâ”‚  â”‚   SHIP   â”‚ â”€â”€â”€ Create PR, await approval, merge                          â”‚\nâ”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                               â”‚\nâ”‚       â”‚                                                                     â”‚\nâ”‚       â–¼                                                                     â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚\nâ”‚  â”‚ COMPLETE â”‚ â”€â”€â”€ Update queue, create handoff, trigger next system         â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               â”‚\nâ”‚                                                                             â”‚\nâ”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FAILURE STATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚\nâ”‚                                                                             â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚\nâ”‚  â”‚  FAILED  â”‚â”€â”€â”€â”€â–¶â”‚  RETRY   â”‚â”€â”€â”€â”€â–¶â”‚ BLOCKED  â”‚                            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚\nâ”‚       â”‚                                   â”‚                                 â”‚\nâ”‚       â””â”€â”€â”€ Auto-retry if retries remain   â”‚                                 â”‚\nâ”‚                                           â””â”€â”€â”€ Human intervention needed    â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### State Definitions\n\n| State | Description | Entry Condition | Exit Condition |\n|-------|-------------|-----------------|----------------|\n| `INIT` | Load context, verify ready | System claimed from queue | Context loaded, worktree ready |\n| `SCAFFOLD` | Create project structure | Init complete | Structure exists, builds |\n| `IMPLEMENT` | Write code for capability | Scaffold done or prev capability done | Code written |\n| `TEST` | Write tests for capability | Implementation done | Tests written |\n| `VERIFY` | Run verification checks | Tests done | Lint, types, tests pass |\n| `VALIDATE` | Full system validation | All capabilities done | Security, perf, integration pass |\n| `DOCUMENT` | Generate documentation | Validation passed | Docs updated |\n| `REVIEW` | Self-review, prep PR | Docs done | PR ready |\n| `SHIP` | Create PR, await merge | Review done | PR merged |\n| `COMPLETE` | Finalize, update queue | PR merged | Queue updated, handoff created |\n| `FAILED` | Something went wrong | Any check fails | Retry initiated or blocked |\n| `RETRY` | Attempting fix | Failure with retries left | Back to failed stage or blocked |\n| `BLOCKED` | Needs human help | Max retries exceeded | Human resolves |\n\n## Loop State File\n\nStore execution state in `loop-state.json`:\n\n```json\n{\n  \"systemId\": \"sys-002\",\n  \"systemName\": \"Work Order Service\",\n  \"githubIssue\": 123,\n  \"branch\": \"feature/system-work-orders\",\n  \"worktree\": \".worktrees/system-work-orders\",\n  \n  \"state\": \"IMPLEMENT\",\n  \"stateEnteredAt\": \"2024-01-17T10:30:00Z\",\n  \n  \"capabilities\": {\n    \"total\": 5,\n    \"completed\": 2,\n    \"current\": \"work-order-assignment\",\n    \"remaining\": [\"status-transitions\", \"completion-flow\"]\n  },\n  \n  \"stages\": {\n    \"INIT\": { \"status\": \"complete\", \"completedAt\": \"2024-01-17T09:00:00Z\" },\n    \"SCAFFOLD\": { \"status\": \"complete\", \"completedAt\": \"2024-01-17T09:30:00Z\" },\n    \"IMPLEMENT\": { \"status\": \"in-progress\", \"startedAt\": \"2024-01-17T09:35:00Z\" },\n    \"TEST\": { \"status\": \"pending\" },\n    \"VERIFY\": { \"status\": \"pending\" },\n    \"VALIDATE\": { \"status\": \"pending\" },\n    \"DOCUMENT\": { \"status\": \"pending\" },\n    \"REVIEW\": { \"status\": \"pending\" },\n    \"SHIP\": { \"status\": \"pending\" },\n    \"COMPLETE\": { \"status\": \"pending\" }\n  },\n  \n  \"failures\": {\n    \"count\": 1,\n    \"maxRetries\": 3,\n    \"history\": [\n      {\n        \"stage\": \"VERIFY\",\n        \"capability\": \"work-order-creation\",\n        \"error\": \"Type error in WorkOrder model\",\n        \"timestamp\": \"2024-01-17T10:15:00Z\",\n        \"resolution\": \"Fixed type definition\",\n        \"resolvedAt\": \"2024-01-17T10:25:00Z\"\n      }\n    ]\n  },\n  \n  \"gates\": {\n    \"architecture\": { \"required\": false },\n    \"security\": { \"required\": true, \"status\": \"pending\" },\n    \"database\": { \"required\": true, \"status\": \"approved\", \"approvedBy\": \"dba@company.com\" },\n    \"deploy\": { \"required\": true, \"status\": \"pending\" }\n  },\n  \n  \"checkpoints\": [\n    { \"type\": \"commit\", \"hash\": \"abc1234\", \"message\": \"feat: work order model\", \"at\": \"...\" },\n    { \"type\": \"commit\", \"hash\": \"def5678\", \"message\": \"feat: create endpoint\", \"at\": \"...\" }\n  ],\n  \n  \"updatedAt\": \"2024-01-17T10:30:00Z\"\n}\n```\n\n### Skills Logging\n\nTrack which skills are invoked, why, and how long they take:\n\n```json\n{\n  \"skillsUsage\": {\n    \"entry-portal\": 1,\n    \"spec\": 1,\n    \"estimation\": 1,\n    \"architect\": 0,\n    \"scaffold\": 0,\n    \"implement\": 0,\n    \"...\": 0\n  },\n  \n  \"skillsLog\": [\n    {\n      \"skill\": \"entry-portal\",\n      \"reason\": \"New domain: define dream state and systems\",\n      \"startedAt\": \"2025-01-17T21:48:00Z\",\n      \"completedAt\": \"2025-01-17T22:00:00Z\",\n      \"durationMs\": 720000,\n      \"status\": \"complete\",\n      \"deliverables\": [\"dream-state.md\", \"system-queue.json\"],\n      \"referencesRead\": [\"clarifying-questions.md\", \"system-decomposition.md\"],\n      \"children\": [\n        {\n          \"skill\": \"spec\",\n          \"reason\": \"Generate FEATURESPEC for first system\",\n          \"startedAt\": \"2025-01-17T21:52:00Z\",\n          \"completedAt\": \"2025-01-17T21:55:00Z\",\n          \"durationMs\": 180000,\n          \"status\": \"complete\",\n          \"deliverables\": [\"FEATURESPEC.md\"]\n        }\n      ]\n    }\n  ]\n}\n```\n\n**skillsUsage** â€” Count of invocations per skill for this system. Provides at-a-glance view of which skills are being used heavily vs rarely.\n\n**skillsLog** â€” Sequential log with full details:\n\n| Field | Description |\n|-------|-------------|\n| `skill` | Skill name |\n| `reason` | Why this skill was invoked |\n| `startedAt` | When skill execution began |\n| `completedAt` | When skill finished |\n| `durationMs` | Execution time in milliseconds |\n| `status` | complete, failed, skipped |\n| `deliverables` | Files produced |\n| `referencesRead` | Reference docs consulted |\n| `children` | Nested skill invocations (e.g., entry-portal â†’ spec) |\n\n**Logging rules:**\n- Create log entry when skill starts\n- Update with completion time and deliverables when skill finishes\n- Increment skillsUsage count on completion\n- Nested calls appear as children of parent skill\n- Failed skills remain in log with status: failed\n\n### Velocity Tracking Integration\n\nFor real-time velocity monitoring, also append to `metrics.skillHistory` when each skill completes:\n\n```json\n{\n  \"metrics\": {\n    \"skillsInvoked\": 5,\n    \"skillHistory\": [\n      {\n        \"skill\": \"implement\",\n        \"timestamp\": \"2025-01-18T10:30:00Z\",\n        \"durationMs\": 1800000\n      }\n    ]\n  }\n}\n```\n\n**Required fields:**\n- `skill`: Name of the skill invoked\n- `timestamp`: ISO-8601 completion timestamp\n- `durationMs`: Duration in milliseconds (optional but recommended)\n\nThis enables velocity-tracker's loop-monitor to detect skill invocations in real-time and display them in the dashboard.\n\nâ†’ See `references/loop-state-schema.json`\n\n## Decision Engine\n\n### Main Decision Loop\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                        DECISION ALGORITHM                                    â”‚\nâ”‚                                                                             â”‚\nâ”‚  function decideNextAction(loopState, context):                             â”‚\nâ”‚                                                                             â”‚\nâ”‚    1. CHECK BLOCKED                                                         â”‚\nâ”‚       if state == BLOCKED:                                                  â”‚\nâ”‚         return { action: \"WAIT_FOR_HUMAN\", reason: blockedReason }          â”‚\nâ”‚                                                                             â”‚\nâ”‚    2. CHECK GATES                                                           â”‚\nâ”‚       gate = getPendingGate(loopState)                                      â”‚\nâ”‚       if gate and gate.required:                                            â”‚\nâ”‚         return { action: \"WAIT_FOR_APPROVAL\", gate: gate }                  â”‚\nâ”‚                                                                             â”‚\nâ”‚    3. CHECK FAILURE                                                         â”‚\nâ”‚       if state == FAILED:                                                   â”‚\nâ”‚         if failures.count < maxRetries:                                     â”‚\nâ”‚           return { action: \"RETRY\", stage: lastFailedStage }                â”‚\nâ”‚         else:                                                               â”‚\nâ”‚           return { action: \"ESCALATE\", reason: \"Max retries exceeded\" }     â”‚\nâ”‚                                                                             â”‚\nâ”‚    4. DETERMINE NEXT STATE                                                  â”‚\nâ”‚       nextState = getNextState(currentState, context)                       â”‚\nâ”‚       skill = getSkillForState(nextState)                                   â”‚\nâ”‚       return { action: \"EXECUTE_SKILL\", state: nextState, skill: skill }    â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### State Transitions\n\n```javascript\nfunction getNextState(current, context) {\n  switch (current) {\n    case \"INIT\":\n      return \"SCAFFOLD\";\n      \n    case \"SCAFFOLD\":\n      return \"IMPLEMENT\";\n      \n    case \"IMPLEMENT\":\n      return \"TEST\";\n      \n    case \"TEST\":\n      return \"VERIFY\";\n      \n    case \"VERIFY\":\n      if (context.capabilities.remaining.length > 0) {\n        // More capabilities to implement\n        return \"IMPLEMENT\";\n      }\n      return \"VALIDATE\";\n      \n    case \"VALIDATE\":\n      return \"DOCUMENT\";\n      \n    case \"DOCUMENT\":\n      return \"REVIEW\";\n      \n    case \"REVIEW\":\n      return \"SHIP\";\n      \n    case \"SHIP\":\n      if (context.prMerged) {\n        return \"COMPLETE\";\n      }\n      return \"SHIP\"; // Wait for merge\n      \n    case \"COMPLETE\":\n      return null; // Done\n      \n    default:\n      throw new Error(`Unknown state: ${current}`);\n  }\n}\n```\n\n### State to Skill Mapping\n\n| State | Primary Skill | Supporting Skills |\n|-------|--------------|-------------------|\n| `INIT` | `memory-manager` (cold boot) | `git-workflow` |\n| `SCAFFOLD` | `scaffold` | `architect` |\n| `IMPLEMENT` | `implement` | â€” |\n| `TEST` | `test-generation` | â€” |\n| `VERIFY` | `code-verification` | `debug-assist` on failure |\n| `VALIDATE` | `code-validation` | `security-audit`, `perf-analysis`, `integration-test` |\n| `DOCUMENT` | `document` | â€” |\n| `REVIEW` | `code-review` | â€” |\n| `SHIP` | `git-workflow` | â€” |\n| `COMPLETE` | `memory-manager` (handoff) | `entry-portal` (queue update) |\n\n### Hard Verification Gates\n\n**Build and tests MUST pass before any stage transition.** This is enforced, not optional.\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                    VERIFICATION GATE (HARD REQUIREMENT)                      â”‚\nâ”‚                                                                             â”‚\nâ”‚  BEFORE transitioning from any state:                                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  1. RUN BUILD                                                               â”‚\nâ”‚     npm run build  (or equivalent)                                          â”‚\nâ”‚     â†’ If fails: STOP, invoke debug-assist, fix, retry                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  2. RUN TESTS (if tests exist)                                              â”‚\nâ”‚     npm test  (or equivalent)                                               â”‚\nâ”‚     â†’ If fails: STOP, invoke debug-assist, fix, retry                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  3. RUN LINT (if configured)                                                â”‚\nâ”‚     npm run lint  (or equivalent)                                           â”‚\nâ”‚     â†’ If fails: STOP, fix lint errors, retry                                â”‚\nâ”‚                                                                             â”‚\nâ”‚  4. LOG VERIFICATION                                                        â”‚\nâ”‚     Record in journey-log: { verification: \"pass\", timestamp: ... }         â”‚\nâ”‚                                                                             â”‚\nâ”‚  ONLY proceed to next state if ALL checks pass                              â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n| Transition | Required Checks | On Failure |\n|------------|-----------------|------------|\n| SCAFFOLD â†’ IMPLEMENT | Build compiles | Fix build errors |\n| IMPLEMENT â†’ TEST | Build compiles | Fix build errors |\n| TEST â†’ VERIFY | Build + Tests pass | Fix failing tests |\n| VERIFY â†’ VALIDATE | Build + Tests + Lint | Fix all issues |\n| VALIDATE â†’ DOCUMENT | Build + Tests | Fix regressions |\n| DOCUMENT â†’ REVIEW | Build + Tests | Fix regressions |\n| REVIEW â†’ SHIP | Build + Tests + Approved | Wait for approval |\n\n**No exceptions.** Autonomous execution must never ship broken code.\n\n## Failure Handling\n\n### Failure Detection\n\n| Check Type | Failure Signal | Severity |\n|------------|---------------|----------|\n| Build | Non-zero exit code | High |\n| Lint | Lint errors | Medium |\n| Type check | Type errors | High |\n| Unit tests | Test failures | High |\n| Integration tests | Test failures | High |\n| Security scan | Critical/High findings | High |\n| Performance | Exceeds thresholds | Medium |\n\n### Retry Strategy\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                         RETRY STRATEGY                                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  On Failure:                                                                â”‚\nâ”‚                                                                             â”‚\nâ”‚  1. CAPTURE                                                                 â”‚\nâ”‚     â€¢ Error message and stack trace                                         â”‚\nâ”‚     â€¢ Failing file/line if available                                        â”‚\nâ”‚     â€¢ Test output if test failure                                           â”‚\nâ”‚                                                                             â”‚\nâ”‚  2. DIAGNOSE                                                                â”‚\nâ”‚     â€¢ Invoke debug-assist skill                                             â”‚\nâ”‚     â€¢ Form hypotheses                                                       â”‚\nâ”‚     â€¢ Identify likely root cause                                            â”‚\nâ”‚                                                                             â”‚\nâ”‚  3. FIX                                                                     â”‚\nâ”‚     â€¢ Apply targeted fix                                                    â”‚\nâ”‚     â€¢ Do NOT change unrelated code                                          â”‚\nâ”‚     â€¢ Commit fix separately                                                 â”‚\nâ”‚                                                                             â”‚\nâ”‚  4. VERIFY FIX                                                              â”‚\nâ”‚     â€¢ Re-run failed check                                                   â”‚\nâ”‚     â€¢ Ensure fix doesn't break other tests                                  â”‚\nâ”‚     â€¢ Run full verification suite                                           â”‚\nâ”‚                                                                             â”‚\nâ”‚  5. CONTINUE OR ESCALATE                                                    â”‚\nâ”‚     â€¢ If fixed: continue to next state                                      â”‚\nâ”‚     â€¢ If still failing: increment retry counter                             â”‚\nâ”‚     â€¢ If max retries: transition to BLOCKED                                 â”‚\nâ”‚                                                                             â”‚\nâ”‚  Retry Limits:                                                              â”‚\nâ”‚     â€¢ Default: 3 retries per failure                                        â”‚\nâ”‚     â€¢ Same error: 2 retries (don't keep trying same thing)                  â”‚\nâ”‚     â€¢ Different error: Reset counter                                        â”‚\nâ”‚     â€¢ Total failures: 10 max before forced BLOCKED                          â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Escalation to Human\n\nTransition to BLOCKED when:\n- Max retries exceeded\n- Circular failure (fix breaks something else, fixing that breaks original)\n- Security finding requires human decision\n- External dependency unavailable\n- Ambiguous requirement discovered\n\nBlocked state message:\n```markdown\n## ğŸš« BLOCKED: [System Name]\n\n**Reason:** [Why blocked]\n**Last Failure:** [Error details]\n**Retry Attempts:** [X] / [Max]\n\n**What was tried:**\n1. [Attempt 1]\n2. [Attempt 2]\n3. [Attempt 3]\n\n**Human action needed:**\n[Specific ask]\n\n**To resume:**\n1. Resolve the issue\n2. Update loop-state.json: set state to [resume state]\n3. Run loop controller\n```\n\nâ†’ See `references/failure-handling.md`\n\n## Verification Gates (Hard Requirements)\n\n**Build and tests MUST pass before any stage transition.** This is a hard gate, not optional.\n\n### Verification Matrix\n\n| Transition | Required Checks | Block If |\n|------------|-----------------|----------|\n| SCAFFOLD â†’ IMPLEMENT | Build compiles | Build fails |\n| IMPLEMENT â†’ TEST | Build compiles | Build fails |\n| TEST â†’ VERIFY | Build + Unit tests | Any test fails |\n| VERIFY â†’ VALIDATE | Build + All tests + Lint | Verification fails |\n| VALIDATE â†’ DOCUMENT | Build + All tests | Validation fails |\n| REVIEW â†’ SHIP | Build + All tests + Review approved | Any check fails |\n\n### Verification Protocol\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                    HARD VERIFICATION GATE                                    â”‚\nâ”‚                                                                             â”‚\nâ”‚  BEFORE any stage transition:                                               â”‚\nâ”‚                                                                             â”‚\nâ”‚  1. RUN BUILD                                                               â”‚\nâ”‚     npm run build  (or equivalent)                                          â”‚\nâ”‚     If fails â†’ STOP, do not transition                                      â”‚\nâ”‚                                                                             â”‚\nâ”‚  2. RUN TESTS                                                               â”‚\nâ”‚     npm test  (or equivalent)                                               â”‚\nâ”‚     If fails â†’ STOP, do not transition                                      â”‚\nâ”‚                                                                             â”‚\nâ”‚  3. RUN LINT (if configured)                                                â”‚\nâ”‚     npm run lint  (or equivalent)                                           â”‚\nâ”‚     If fails â†’ STOP, do not transition                                      â”‚\nâ”‚                                                                             â”‚\nâ”‚  4. RECORD RESULT                                                           â”‚\nâ”‚     Log verification status in journey-log                                  â”‚\nâ”‚     Update loop-state.json with lastVerification timestamp                  â”‚\nâ”‚                                                                             â”‚\nâ”‚  ONLY if all pass â†’ Transition to next stage                                â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Verification Commands\n\nStandard commands to run (adapt to project):\n\n```bash\n# TypeScript/Node\nnpm run build && npm test && npm run lint\n\n# Python\npython -m pytest && python -m flake8 && python -m mypy .\n\n# Django\npython manage.py check && python manage.py test\n\n# Rust\ncargo build && cargo test && cargo clippy\n```\n\n### On Verification Failure\n\n1. **Do NOT proceed to next stage**\n2. Invoke `debug-assist` skill to diagnose\n3. Fix the issue\n4. Re-run verification\n5. Only transition when all checks pass\n\nThis ensures autonomous execution never ships broken code.\n\n## Mandatory Skill Enforcement\n\n### Phase Skill Requirements\n\nBefore transitioning out of any phase, ALL required skills for that phase MUST be completed (or explicitly skipped).\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                    MANDATORY SKILL CHECK                                     â”‚\nâ”‚                                                                             â”‚\nâ”‚  BEFORE transitioning from any phase:                                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  1. GET REQUIRED SKILLS                                                     â”‚\nâ”‚     required = skillExecution[currentPhase].required                        â”‚\nâ”‚                                                                             â”‚\nâ”‚  2. CHECK COMPLETION                                                        â”‚\nâ”‚     completed = skillExecution[currentPhase].completed                      â”‚\nâ”‚     skipped = skillExecution[currentPhase].skipped                          â”‚\nâ”‚     missing = required - completed - skipped                                â”‚\nâ”‚                                                                             â”‚\nâ”‚  3. BLOCK IF MISSING                                                        â”‚\nâ”‚     if missing.length > 0:                                                  â”‚\nâ”‚       Display: \"âš ï¸ Cannot proceed: [skill] not invoked\"                     â”‚\nâ”‚       Options:                                                              â”‚\nâ”‚         - Invoke the skill now                                              â”‚\nâ”‚         - Skip with reason: skip [skill] --reason \"explanation\"             â”‚\nâ”‚       STOP - do not transition                                              â”‚\nâ”‚                                                                             â”‚\nâ”‚  4. VERIFY DELIVERABLES                                                     â”‚\nâ”‚     Run skill-verifier on all completed skills                              â”‚\nâ”‚     if verification fails: BLOCK                                            â”‚\nâ”‚                                                                             â”‚\nâ”‚  5. PROCEED                                                                 â”‚\nâ”‚     Only if all checks pass â†’ Transition to next phase                      â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Required Skills by Phase\n\n| Phase | Required Skills |\n|-------|-----------------|\n| INIT | entry-portal, requirements, spec, estimation, triage, memory-manager |\n| SCAFFOLD | architect, architecture-review, scaffold, git-workflow |\n| IMPLEMENT | implement |\n| TEST | test-generation |\n| VERIFY | code-verification (+ debug-assist if tests fail) |\n| VALIDATE | code-validation, integration-test, security-audit, perf-analysis |\n| DOCUMENT | document |\n| REVIEW | code-review, refactor |\n| SHIP | deploy, git-workflow |\n| COMPLETE | memory-manager, retrospective, calibration-tracker, loop-controller |\n\n### Skip Command\n\nWhen a mandatory skill cannot be completed, use the skip command:\n\n```bash\nskip [skill] --reason \"explanation\"\n```\n\nExample:\n```bash\nskip git-workflow --reason \"No git repo configured, user chose to continue without version control\"\nskip security-audit --reason \"CLI tool with no user input, security audit not applicable\"\n```\n\nSkips are recorded in:\n- `loop-state.json` â†’ `skillExecution[phase].skipped`\n- `journey-log.jsonl` â†’ Entry with `status: \"skipped\"` and `reason`\n\n### Prerequisite Prompts\n\nFor skills with external dependencies:\n\n| Skill | Prerequisite | Prompt |\n|-------|--------------|--------|\n| git-workflow | .git/ directory | \"No git repo configured. 'init' to create or 'skip git' to continue without\" |\n| deploy | Deploy target | \"No deploy target configured. Specify target or 'skip deploy' to skip\" |\n\nRecord prerequisite decisions in `loop-state.json`:\n```json\n{\n  \"prerequisites\": {\n    \"git\": { \"status\": \"configured|skipped\", \"prompted\": true },\n    \"deploy\": { \"status\": \"configured|skipped\", \"target\": \"npm publish\", \"prompted\": true }\n  }\n}\n```\n\n---\n\n## Human Gates\n\n### Gate Types\n\n| Gate | Trigger | Approver | How to Approve |\n|------|---------|----------|----------------|\n| `architecture` | New patterns, major structural changes | Tech Lead | PR comment: \"architecture approved\" |\n| `security` | Auth, crypto, PII handling | Security Team | Security review checklist |\n| `database` | Schema migrations | DBA | Migration review |\n| `external` | Third-party API integration | Tech Lead | Integration review |\n| `deploy` | Production merge | Release Manager | PR approval |\n\n### Gate Enforcement\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                         GATE CHECK                                           â”‚\nâ”‚                                                                             â”‚\nâ”‚  function checkGates(loopState, changesInStage):                            â”‚\nâ”‚                                                                             â”‚\nâ”‚    // Determine which gates apply                                           â”‚\nâ”‚    requiredGates = []                                                       â”‚\nâ”‚                                                                             â”‚\nâ”‚    if changesInStage.hasNewArchitecturalPatterns:                           â”‚\nâ”‚      requiredGates.push(\"architecture\")                                     â”‚\nâ”‚                                                                             â”‚\nâ”‚    if changesInStage.touchesSecurity:                                       â”‚\nâ”‚      requiredGates.push(\"security\")                                         â”‚\nâ”‚                                                                             â”‚\nâ”‚    if changesInStage.hasSchemaChanges:                                      â”‚\nâ”‚      requiredGates.push(\"database\")                                         â”‚\nâ”‚                                                                             â”‚\nâ”‚    if changesInStage.hasExternalAPIs:                                       â”‚\nâ”‚      requiredGates.push(\"external\")                                         â”‚\nâ”‚                                                                             â”‚\nâ”‚    // Always require deploy gate for SHIP                                   â”‚\nâ”‚    if currentState == \"REVIEW\":                                             â”‚\nâ”‚      requiredGates.push(\"deploy\")                                           â”‚\nâ”‚                                                                             â”‚\nâ”‚    // Check approval status                                                 â”‚\nâ”‚    for gate in requiredGates:                                               â”‚\nâ”‚      if not loopState.gates[gate].approved:                                 â”‚\nâ”‚        return { blocked: true, gate: gate }                                 â”‚\nâ”‚                                                                             â”‚\nâ”‚    return { blocked: false }                                                â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Requesting Approval\n\nWhen gate is required:\n1. Create PR (or update existing)\n2. Add appropriate label (`needs:security-review`, etc.)\n3. Add reviewer\n4. Post comment explaining what needs review\n5. Transition to waiting state\n6. Check periodically for approval\n\n```bash\n# Request security review\ngh pr edit $PR_NUMBER \\\n  --add-label \"needs:security-review\" \\\n  --add-reviewer @security-team\n\ngh pr comment $PR_NUMBER --body \"## Security Review Requested\n\nThis PR includes authentication changes:\n- JWT token handling in \\`src/auth/\\`\n- Password hashing in \\`src/users/\\`\n\nPlease review per security checklist.\"\n```\n\nâ†’ See `references/gate-procedures.md`\n\n## Completion Criteria\n\n### System Complete When\n\nAll must be true:\n- [ ] All capabilities implemented\n- [ ] All tests passing\n- [ ] Code verification passing (lint, types, complexity)\n- [ ] Code validation passing (logic, requirements)\n- [ ] Security audit passing (no critical/high)\n- [ ] Performance targets met\n- [ ] Documentation updated\n- [ ] Code review self-assessment passing\n- [ ] PR approved and merged\n- [ ] All required gates approved\n\n### Completion Actions\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                        ON COMPLETION                                         â”‚\nâ”‚                                                                             â”‚\nâ”‚  1. UPDATE QUEUE                                                            â”‚\nâ”‚     â€¢ Set system status to \"complete\"                                       â”‚\nâ”‚     â€¢ Set completedAt timestamp                                             â”‚\nâ”‚     â€¢ Identify newly unblocked systems                                      â”‚\nâ”‚                                                                             â”‚\nâ”‚  2. CREATE HANDOFF                                                          â”‚\nâ”‚     â€¢ Document what was built                                               â”‚\nâ”‚     â€¢ Note any deferred items                                               â”‚\nâ”‚     â€¢ Archive to sessions/                                                  â”‚\nâ”‚                                                                             â”‚\nâ”‚  3. UPDATE INTERFACES                                                       â”‚\nâ”‚     â€¢ Finalize API contracts                                                â”‚\nâ”‚     â€¢ Update event schemas                                                  â”‚\nâ”‚     â€¢ Notify dependent systems                                              â”‚\nâ”‚                                                                             â”‚\nâ”‚  4. CLEAN UP                                                                â”‚\nâ”‚     â€¢ Remove loop-state.json (or archive)                                   â”‚\nâ”‚     â€¢ Remove worktree                                                       â”‚\nâ”‚     â€¢ Delete branch (if configured)                                         â”‚\nâ”‚                                                                             â”‚\nâ”‚  5. TRIGGER NEXT                                                            â”‚\nâ”‚     â€¢ Check queue for next ready system                                     â”‚\nâ”‚     â€¢ If found and auto-continue: start next                                â”‚\nâ”‚     â€¢ If found and manual: notify human                                     â”‚\nâ”‚     â€¢ If none: report domain progress                                       â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Running the Loop\n\n### Manual Execution\n\n```bash\n# 1. Initialize loop for a system\n./loop init sys-002\n\n# 2. Run one iteration\n./loop next\n\n# 3. Check status\n./loop status\n\n# 4. Run until blocked or complete\n./loop run\n\n# 5. Resume after human intervention\n./loop resume\n```\n\n### Session Integration\n\nAt start of session:\n```markdown\n1. Cold boot (memory-manager)\n2. Load loop-state.json\n3. Call loop controller: decideNextAction()\n4. Execute returned action\n5. Update loop-state.json\n6. Repeat until session ends or system completes\n```\n\nAt end of session:\n```markdown\n1. Complete current skill cleanly (don't leave mid-implementation)\n2. Commit any pending changes\n3. Update loop-state.json\n4. Create session handoff (memory-manager)\n5. Save all state files\n```\n\n## Loop Commands Reference\n\n### Initialize\n\n```bash\n# From queue, claim next ready system\nloop init --next\n\n# Specific system\nloop init sys-002\n\n# Creates:\n# - Worktree\n# - loop-state.json\n# - Initial branch\n```\n\n### Status\n\n```bash\nloop status\n\n# Output:\n# System: Work Order Service (sys-002)\n# State: IMPLEMENT (capability 3/5: work-order-assignment)\n# Failures: 1 (resolved)\n# Gates: database âœ“, security pending\n# Last activity: 2024-01-17T10:30:00Z\n```\n\n### Next\n\n```bash\nloop next\n\n# Executes one state transition:\n# 1. Decide next action\n# 2. Execute skill\n# 3. Update state\n# 4. Return\n```\n\n### Run\n\n```bash\nloop run\n\n# Runs until:\n# - COMPLETE reached\n# - BLOCKED reached\n# - Gate requires approval\n# - Max iterations (safety)\n```\n\n### Resume\n\n```bash\nloop resume\n\n# After human intervention:\n# 1. Validates state\n# 2. Clears BLOCKED if resolved\n# 3. Continues from current state\n```\n\n## Relationship to Other Skills\n\n| Skill | Relationship |\n|-------|--------------|\n| All 17 other skills | Loop controller invokes them based on state |\n| `memory-manager` | Provides cold boot and handoff |\n| `entry-portal` | Provides systems to build, queue updates |\n| `git-workflow` | Provides worktree and PR operations |\n| `debug-assist` | Invoked on failures |\n\n## Key Principles\n\n**One state at a time.** Complete current state before transitioning.\n\n**Fail fast, retry smart.** Detect failures immediately, diagnose before retrying.\n\n**Gates are non-negotiable.** Never bypass required human approvals.\n\n**State is sacred.** Always update loop-state.json after any change.\n\n**Clean handoffs.** Never end session with corrupt or ambiguous state.\n\n## References\n\n- `references/loop-state-schema.json`: JSON Schema for state file\n- `references/failure-handling.md`: Detailed retry and escalation logic\n- `references/gate-procedures.md`: How to request and check approvals\n- `references/decision-trees.md`: Visual decision flowcharts",
  "references": [
    {
      "name": "autonomy-configuration.md",
      "path": "references/autonomy-configuration.md",
      "content": "# Autonomy Configuration\n\nConfigure execution mode for the engineering loop.\n\n## Execution Modes\n\n| Mode | Description | Human Involvement | Use Case |\n|------|-------------|-------------------|----------|\n| **Autonomous** | Run to completion | Only on failure escalation | Small systems, high confidence |\n| **Supervised** | Pause at configured gates | Approval at stage boundaries | Large systems, enterprise |\n| **Hybrid** | Autonomous with critical gates | Approval only for high-risk stages | Standard projects |\n\n## Domain-Level Configuration\n\nSet default mode for all systems in a domain:\n\n```json\n// domain-memory/{domain}/config.json\n{\n  \"autonomy\": {\n    \"defaultMode\": \"hybrid\",\n    \"failureRetries\": 3,\n    \"escalationTimeout\": \"30m\",\n    \"gates\": {\n      \"architecture\": {\n        \"required\": true,\n        \"mode\": \"human\",\n        \"description\": \"Architecture approval before implementation\"\n      },\n      \"security\": {\n        \"required\": true,\n        \"mode\": \"human\",\n        \"description\": \"Security review before ship\"\n      },\n      \"deploy\": {\n        \"required\": true,\n        \"mode\": \"human\",\n        \"description\": \"Deploy approval before production\"\n      }\n    }\n  }\n}\n```\n\n## System-Level Override\n\nOverride domain defaults for specific systems:\n\n```json\n// In system-queue.json, per system\n{\n  \"id\": \"sys-001\",\n  \"name\": \"Auth Service\",\n  \"autonomy\": {\n    \"mode\": \"supervised\",\n    \"gates\": {\n      \"architecture\": { \"required\": true },\n      \"security\": { \"required\": true },\n      \"database\": { \"required\": true },\n      \"deploy\": { \"required\": true }\n    },\n    \"reason\": \"Security-critical system requires full oversight\"\n  }\n}\n```\n\n## Mode Behaviors\n\n### Autonomous Mode\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                        AUTONOMOUS MODE                                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  Agent executes continuously until:                                         â”‚\nâ”‚  â€¢ System is complete, OR                                                   â”‚\nâ”‚  â€¢ Unrecoverable failure (max retries exceeded), OR                         â”‚\nâ”‚  â€¢ Explicitly configured gate                                               â”‚\nâ”‚                                                                             â”‚\nâ”‚  INIT â”€â”€â–¶ SCAFFOLD â”€â”€â–¶ IMPLEMENT â”€â”€â–¶ TEST â”€â”€â–¶ VERIFY â”€â”€â–¶                   â”‚\nâ”‚  VALIDATE â”€â”€â–¶ DOCUMENT â”€â”€â–¶ REVIEW â”€â”€â–¶ SHIP â”€â”€â–¶ COMPLETE                    â”‚\nâ”‚                                                                             â”‚\nâ”‚  No human interaction unless failure escalation                             â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Supervised Mode\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                        SUPERVISED MODE                                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  Agent pauses at each configured gate for human approval:                   â”‚\nâ”‚                                                                             â”‚\nâ”‚  INIT â”€â”€â–¶ [GATE: Architecture] â”€â”€â–¶ SCAFFOLD â”€â”€â–¶ IMPLEMENT â”€â”€â–¶              â”‚\nâ”‚  TEST â”€â”€â–¶ VERIFY â”€â”€â–¶ VALIDATE â”€â”€â–¶ [GATE: Security] â”€â”€â–¶                     â”‚\nâ”‚  DOCUMENT â”€â”€â–¶ REVIEW â”€â”€â–¶ [GATE: Deploy] â”€â”€â–¶ SHIP â”€â”€â–¶ COMPLETE              â”‚\nâ”‚                                                                             â”‚\nâ”‚  Human receives notification at each gate                                   â”‚\nâ”‚  Agent waits for approval/feedback before proceeding                        â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Hybrid Mode (Default)\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                        HYBRID MODE                                           â”‚\nâ”‚                                                                             â”‚\nâ”‚  Agent runs autonomously with gates only at critical points:                â”‚\nâ”‚                                                                             â”‚\nâ”‚  INIT â”€â”€â–¶ SCAFFOLD â”€â”€â–¶ IMPLEMENT â”€â”€â–¶ TEST â”€â”€â–¶ VERIFY â”€â”€â–¶                   â”‚\nâ”‚  VALIDATE â”€â”€â–¶ [GATE: Security] â”€â”€â–¶ DOCUMENT â”€â”€â–¶ REVIEW â”€â”€â–¶                 â”‚\nâ”‚  [GATE: Deploy] â”€â”€â–¶ SHIP â”€â”€â–¶ COMPLETE                                      â”‚\nâ”‚                                                                             â”‚\nâ”‚  Security gate: Ensure no vulnerabilities before shipping                   â”‚\nâ”‚  Deploy gate: Ensure readiness before production                            â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Gate Types\n\n| Gate | Stage | Mode | Risk Level |\n|------|-------|------|------------|\n| `specification` | After INIT | Optional | Low |\n| `architecture` | After SCAFFOLD | Recommended | Medium |\n| `implementation` | After IMPLEMENT | Optional | Low |\n| `security` | After VALIDATE | **Recommended** | High |\n| `database` | Before DB migrations | Context-dependent | Medium |\n| `deploy` | Before SHIP | **Recommended** | High |\n\n## Gate Approval Flow\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                        GATE APPROVAL FLOW                                    â”‚\nâ”‚                                                                             â”‚\nâ”‚  1. GATE TRIGGERED                                                          â”‚\nâ”‚     â””â”€â†’ Agent reaches configured gate                                       â”‚\nâ”‚     â””â”€â†’ Generate gate summary (what was done, what's next)                  â”‚\nâ”‚     â””â”€â†’ Create notification for human                                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  2. HUMAN REVIEW                                                            â”‚\nâ”‚     â””â”€â†’ Human receives notification (GitHub, Slack, email)                  â”‚\nâ”‚     â””â”€â†’ Reviews deliverables and summary                                    â”‚\nâ”‚     â””â”€â†’ Provides decision: APPROVE / REQUEST_CHANGES / REJECT               â”‚\nâ”‚                                                                             â”‚\nâ”‚  3. GATE RESOLUTION                                                         â”‚\nâ”‚     â””â”€â†’ APPROVE: Agent proceeds to next stage                               â”‚\nâ”‚     â””â”€â†’ REQUEST_CHANGES: Agent addresses feedback, re-triggers gate         â”‚\nâ”‚     â””â”€â†’ REJECT: Agent marks system as BLOCKED, creates handoff              â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Failure Handling with Autonomy\n\n### Automatic Retry\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                        AUTOMATIC RETRY                                       â”‚\nâ”‚                                                                             â”‚\nâ”‚  On failure:                                                                â”‚\nâ”‚  1. Log failure to journey                                                  â”‚\nâ”‚  2. Invoke debug-assist to diagnose                                         â”‚\nâ”‚  3. Attempt fix                                                             â”‚\nâ”‚  4. Re-run failed stage                                                     â”‚\nâ”‚  5. If still failing:                                                       â”‚\nâ”‚     â””â”€â†’ If retries < max: Go to step 2                                      â”‚\nâ”‚     â””â”€â†’ If retries >= max: Escalate to human                                â”‚\nâ”‚                                                                             â”‚\nâ”‚  Default max retries: 3                                                     â”‚\nâ”‚  Retry timeout: 30 minutes per attempt                                      â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Human Escalation\n\nWhen automatic retry fails:\n\n```markdown\n## Escalation: [System Name]\n\n**Stage:** [Failed Stage]\n**Attempts:** 3/3\n**Time in Failure:** 45 minutes\n\n### Failure Summary\n[What went wrong]\n\n### Attempted Fixes\n1. [Fix 1] â€” Result: [Still failing]\n2. [Fix 2] â€” Result: [Still failing]\n3. [Fix 3] â€” Result: [Still failing]\n\n### Diagnostics\n[Debug output, logs, error messages]\n\n### Recommended Actions\n1. [Action human should take]\n2. [Alternative approach]\n\n### To Resume\nAfter resolving, run:\n```\n/resume --domain {domain} --system {system}\n```\n```\n\n## Configuration Examples\n\n### Small Personal Project (Full Autonomy)\n\n```json\n{\n  \"autonomy\": {\n    \"defaultMode\": \"autonomous\",\n    \"gates\": {},\n    \"failureRetries\": 5,\n    \"reason\": \"Personal project, trust agent fully\"\n  }\n}\n```\n\n### Standard Team Project (Hybrid)\n\n```json\n{\n  \"autonomy\": {\n    \"defaultMode\": \"hybrid\",\n    \"gates\": {\n      \"security\": { \"required\": true },\n      \"deploy\": { \"required\": true }\n    },\n    \"failureRetries\": 3,\n    \"reason\": \"Team project with standard oversight\"\n  }\n}\n```\n\n### Enterprise Critical System (Supervised)\n\n```json\n{\n  \"autonomy\": {\n    \"defaultMode\": \"supervised\",\n    \"gates\": {\n      \"specification\": { \"required\": true },\n      \"architecture\": { \"required\": true },\n      \"security\": { \"required\": true },\n      \"database\": { \"required\": true },\n      \"deploy\": { \"required\": true }\n    },\n    \"failureRetries\": 1,\n    \"notificationChannel\": \"slack:#security-reviews\",\n    \"reason\": \"Critical system requires full human oversight\"\n  }\n}\n```\n\n## Integration Points\n\n### With Journey Tracer\n\n- Log mode and gates in journey\n- Track time waiting at gates\n- Record approval/rejection history\n\n### With Skill Verifier\n\n- Gates trigger skill verification\n- Gate approval includes verification status\n- Failed verification blocks gate approval\n\n### With MCP Tools\n\n```\nloop_state_update:\n  - Set autonomy mode\n  - Configure gates\n  - Record gate approvals\n\nqueue_update:\n  - Set per-system autonomy overrides\n```\n\n## User Experience\n\n### Starting Autonomous Build\n\n```\nUser: \"Let's build a notification service\"\n\nAgent: \n  I'll create a notification service for you. Based on domain config:\n  - Mode: Hybrid (autonomous with security and deploy gates)\n  - Expected time: ~4 hours\n  - Human approval needed: Security review, Deploy approval\n  \n  Starting now. I'll notify you when I reach a gate or complete.\n  \n  [Begins execution...]\n```\n\n### Gate Notification\n\n```\nAgent:\n  ğŸš¦ Security Gate Reached â€” Notification Service\n  \n  ## Summary\n  - Implementation complete (4 capabilities)\n  - All tests passing\n  - Verification: PASS\n  \n  ## Security Findings\n  - No vulnerabilities detected\n  - Input validation: âœ…\n  - Authentication: âœ…\n  - Authorization: âœ…\n  \n  ## Ready for Review\n  [Link to VALIDATION.md]\n  [Link to security section]\n  \n  Reply with:\n  - \"approve\" to continue\n  - \"changes: <feedback>\" for modifications\n  - \"reject\" to stop\n```\n\n### Failure Escalation\n\n```\nAgent:\n  âš ï¸ Escalation Required â€” Notification Service\n  \n  I've attempted to fix this issue 3 times without success.\n  \n  ## Issue\n  Database connection failing in test environment\n  \n  ## Attempted\n  1. Verified credentials â€” correct\n  2. Checked network â€” reachable\n  3. Increased timeout â€” still failing\n  \n  ## Need Human Help\n  Likely infrastructure issue beyond my access.\n  \n  Once resolved, reply \"resume\" to continue.\n```\n\n## Autonomy Checklist\n\n```markdown\n## Autonomy Configuration Verification\n\n### Domain Config\n- [ ] config.json exists with autonomy settings\n- [ ] Default mode appropriate for domain\n- [ ] Gates configured for risk level\n- [ ] Failure retries reasonable\n\n### System Overrides\n- [ ] Critical systems have explicit config\n- [ ] Security-sensitive systems have human gates\n- [ ] Notification channels configured\n\n### Execution\n- [ ] Agent respects configured mode\n- [ ] Gates trigger correctly\n- [ ] Escalation works\n- [ ] Resume from escalation works\n```\n"
    },
    {
      "name": "decision-trees.md",
      "path": "references/decision-trees.md",
      "content": "# Decision Trees\n\nVisual flowcharts for loop controller decisions.\n\n## Main Decision Loop\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                      MAIN DECISION LOOP                                      â”‚\nâ”‚                                                                             â”‚\nâ”‚  START                                                                      â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â–¼                                                                        â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Load loop-state.json    â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Is state == BLOCKED?    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Return: WAIT_HUMAN  â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â”‚ NO                                                           â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Is state == COMPLETE?   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Return: DONE        â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â”‚ NO                                                           â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Is state == FAILED?     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Go to RETRY DECISIONâ”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â”‚ NO                                                           â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Is gate pending?        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Return: WAIT_GATE   â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â”‚ NO                                                           â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Get next state          â”‚                                                â”‚\nâ”‚  â”‚ Get skill for state     â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Return: EXECUTE_SKILL   â”‚                                                â”‚\nâ”‚  â”‚ { state, skill }        â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Retry Decision\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                      RETRY DECISION                                          â”‚\nâ”‚                                                                             â”‚\nâ”‚  FAILED STATE                                                               â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â–¼                                                                        â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Is security finding?    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Return: ESCALATE    â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ (never auto-retry)  â”‚            â”‚\nâ”‚              â”‚ NO                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Same error 3x?          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Return: ESCALATE    â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ (same error stuck)  â”‚            â”‚\nâ”‚              â”‚ NO                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Total failures > 10?    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Return: ESCALATE    â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ (too many failures) â”‚            â”‚\nâ”‚              â”‚ NO                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Retries >= 3?           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Return: ESCALATE    â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ (max retries)       â”‚            â”‚\nâ”‚              â”‚ NO                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Return: RETRY           â”‚                                                â”‚\nâ”‚  â”‚ { stage, diagnosis }    â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Gate Check Decision\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                      GATE CHECK                                              â”‚\nâ”‚                                                                             â”‚\nâ”‚  ENTERING NEW STATE                                                         â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â–¼                                                                        â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Analyze changes in      â”‚                                                â”‚\nâ”‚  â”‚ current state           â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Has arch patterns?      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ architecture = REQ  â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â”‚ NO                                   â”‚                       â”‚\nâ”‚              â–¼                                      â”‚                       â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Has security changes?   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ security = REQ      â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â”‚ NO                                   â”‚                       â”‚\nâ”‚              â–¼                                      â”‚                       â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Has schema changes?     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ database = REQ      â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â”‚ NO                                   â”‚                       â”‚\nâ”‚              â–¼                                      â”‚                       â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ Has external APIs?      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ external = REQ      â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â”‚ NO                                   â”‚                       â”‚\nâ”‚              â–¼                                      â”‚                       â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚\nâ”‚  â”‚ State == REVIEW?        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ deploy = REQ        â”‚            â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚\nâ”‚              â”‚ NO                                   â”‚                       â”‚\nâ”‚              â–¼                                      â–¼                       â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚\nâ”‚  â”‚                 Check required gates                         â”‚           â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚\nâ”‚                              â”‚                                              â”‚\nâ”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚\nâ”‚              â–¼                               â–¼                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚\nâ”‚  â”‚ All approved?       â”‚         â”‚ Pending gates exist â”‚                   â”‚\nâ”‚  â”‚ Continue execution  â”‚         â”‚ Wait for approval   â”‚                   â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## State Transition Decision\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                   STATE TRANSITION                                           â”‚\nâ”‚                                                                             â”‚\nâ”‚  CURRENT STATE                                                              â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â”œâ”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ SCAFFOLD             â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â”œâ”€â”€ SCAFFOLD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ IMPLEMENT            â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â”œâ”€â”€ IMPLEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ TEST                 â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â”œâ”€â”€ TEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ VERIFY               â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â”œâ”€â”€ VERIFY â”€â”€â”¬â”€â”€ More capabilities? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ IMPLEMENT            â”‚\nâ”‚    â”‚            â””â”€â”€ All done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ VALIDATE             â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â”œâ”€â”€ VALIDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ DOCUMENT             â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â”œâ”€â”€ DOCUMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ REVIEW               â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â”œâ”€â”€ REVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ SHIP                 â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â”œâ”€â”€ SHIP â”€â”€â”€â”€â”¬â”€â”€ PR merged â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ COMPLETE             â”‚\nâ”‚    â”‚            â””â”€â”€ Waiting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ SHIP (poll)          â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â””â”€â”€ COMPLETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ (terminal)           â”‚\nâ”‚                                                                             â”‚\nâ”‚                                                                             â”‚\nâ”‚    ANY STATE â”€â”€â”€â”¬â”€â”€ Check fails â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ FAILED               â”‚\nâ”‚                 â””â”€â”€ External error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ FAILED               â”‚\nâ”‚                                                                             â”‚\nâ”‚    FAILED â”€â”€â”€â”€â”€â”€â”¬â”€â”€ Retries left â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ RETRY â†’ (prev state) â”‚\nâ”‚                 â””â”€â”€ Max retries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ BLOCKED              â”‚\nâ”‚                                                                             â”‚\nâ”‚    BLOCKED â”€â”€â”€â”€â”€â”€â”€ Human resolves â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ (any state)          â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Capability Loop\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                   CAPABILITY LOOP                                            â”‚\nâ”‚                                                                             â”‚\nâ”‚  START IMPLEMENTATION                                                       â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â–¼                                                                        â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Get next capability     â”‚                                                â”‚\nâ”‚  â”‚ from remaining[]        â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ IMPLEMENT capability    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚\nâ”‚  â”‚ (invoke implement)      â”‚                          â”‚                     â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚                     â”‚\nâ”‚              â”‚                                        â”‚                     â”‚\nâ”‚              â–¼                                        â”‚                     â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚                     â”‚\nâ”‚  â”‚ TEST capability         â”‚                          â”‚                     â”‚\nâ”‚  â”‚ (invoke test-generation)â”‚                          â”‚                     â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚                     â”‚\nâ”‚              â”‚                                        â”‚                     â”‚\nâ”‚              â–¼                                        â”‚                     â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚                     â”‚\nâ”‚  â”‚ VERIFY capability       â”‚                          â”‚                     â”‚\nâ”‚  â”‚ (invoke code-verify)    â”‚                          â”‚                     â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚                     â”‚\nâ”‚              â”‚                                        â”‚                     â”‚\nâ”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚                     â”‚\nâ”‚    â–¼                   â–¼                              â”‚                     â”‚\nâ”‚  PASS               FAIL                              â”‚                     â”‚\nâ”‚    â”‚                   â”‚                              â”‚                     â”‚\nâ”‚    â”‚                   â–¼                              â”‚                     â”‚\nâ”‚    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                     â”‚\nâ”‚    â”‚         â”‚ Retry with debug-assist â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚\nâ”‚    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â–¼                                                                        â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Commit capability       â”‚                                                â”‚\nâ”‚  â”‚ Move to completed[]     â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     YES                                        â”‚\nâ”‚  â”‚ More capabilities?      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ (loop back to IMPLEMENT)          â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚ NO                                                           â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Transition to VALIDATE  â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Completion Decision\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                   COMPLETION CHECK                                           â”‚\nâ”‚                                                                             â”‚\nâ”‚  PR MERGED                                                                  â”‚\nâ”‚    â”‚                                                                        â”‚\nâ”‚    â–¼                                                                        â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ All stages complete?    â”‚                                                â”‚\nâ”‚  â”‚ (all status=complete)   â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚\nâ”‚    â–¼                   â–¼                                                    â”‚\nâ”‚   YES                  NO                                                   â”‚\nâ”‚    â”‚                   â”‚                                                    â”‚\nâ”‚    â”‚                   â–¼                                                    â”‚\nâ”‚    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚\nâ”‚    â”‚         â”‚ ERROR: Invalid state    â”‚                                    â”‚\nâ”‚    â”‚         â”‚ (should not happen)     â”‚                                    â”‚\nâ”‚    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚\nâ”‚    â–¼                                                                        â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Update system-queue     â”‚                                                â”‚\nâ”‚  â”‚ status = \"complete\"     â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Create completion       â”‚                                                â”‚\nâ”‚  â”‚ handoff document        â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Clean up worktree       â”‚                                                â”‚\nâ”‚  â”‚ Archive loop-state      â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚              â–¼                                                              â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚\nâ”‚  â”‚ Check for next system   â”‚                                                â”‚\nâ”‚  â”‚ in queue                â”‚                                                â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚\nâ”‚              â”‚                                                              â”‚\nâ”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚\nâ”‚    â–¼                   â–¼                                                    â”‚\nâ”‚  FOUND              NONE                                                    â”‚\nâ”‚    â”‚                   â”‚                                                    â”‚\nâ”‚    â–¼                   â–¼                                                    â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚\nâ”‚  â”‚ Start next    â”‚  â”‚ Domain progress   â”‚                                   â”‚\nâ”‚  â”‚ system        â”‚  â”‚ report: X% done   â”‚                                   â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n"
    },
    {
      "name": "failure-handling.md",
      "path": "references/failure-handling.md",
      "content": "# Failure Handling\n\nComprehensive guide to detecting, diagnosing, and recovering from failures.\n\n## Failure Categories\n\n| Category | Examples | Severity | Auto-Retry |\n|----------|----------|----------|------------|\n| **Build** | Compile error, missing dependency | High | Yes |\n| **Lint** | Style violations, formatting | Low | Yes |\n| **Type** | Type errors, interface mismatch | High | Yes |\n| **Test** | Unit/integration test failure | High | Yes |\n| **Security** | Vulnerability detected | Critical | No |\n| **Performance** | Threshold exceeded | Medium | Limited |\n| **External** | API unavailable, timeout | Medium | Yes (with backoff) |\n| **Logic** | Infinite loop, deadlock | Critical | No |\n\n## Detection\n\n### Build Failure Detection\n\n```bash\n# Capture build output\nBUILD_OUTPUT=$(npm run build 2>&1)\nBUILD_EXIT=$?\n\nif [ $BUILD_EXIT -ne 0 ]; then\n  echo \"Build failed with exit code $BUILD_EXIT\"\n  echo \"$BUILD_OUTPUT\" > .failure-log\n  # Transition to FAILED\nfi\n```\n\n### Test Failure Detection\n\n```bash\n# Run tests with JSON output\nnpm test -- --json --outputFile=test-results.json\n\n# Parse results\nFAILED=$(jq '.numFailedTests' test-results.json)\nif [ \"$FAILED\" -gt 0 ]; then\n  # Extract failed test names\n  jq '.testResults[].assertionResults[] | select(.status==\"failed\") | .fullName' test-results.json\n  # Transition to FAILED\nfi\n```\n\n### Lint Failure Detection\n\n```bash\n# Run lint with machine-readable output\nnpm run lint -- --format json > lint-results.json 2>&1\nLINT_EXIT=$?\n\nif [ $LINT_EXIT -ne 0 ]; then\n  ERROR_COUNT=$(jq '[.[] | .errorCount] | add' lint-results.json)\n  echo \"Lint failed with $ERROR_COUNT errors\"\n  # Transition to FAILED\nfi\n```\n\n## Diagnosis\n\n### Diagnosis Flow\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                       DIAGNOSIS FLOW                                         â”‚\nâ”‚                                                                             â”‚\nâ”‚  1. CAPTURE ERROR                                                           â”‚\nâ”‚     â”œâ”€â†’ Full error message                                                  â”‚\nâ”‚     â”œâ”€â†’ Stack trace (if available)                                          â”‚\nâ”‚     â”œâ”€â†’ File and line number                                                â”‚\nâ”‚     â””â”€â†’ Context (what was being executed)                                   â”‚\nâ”‚                                                                             â”‚\nâ”‚  2. CATEGORIZE                                                              â”‚\nâ”‚     â”œâ”€â†’ Build / Lint / Type / Test / Security / External?                   â”‚\nâ”‚     â””â”€â†’ Determines retry strategy                                           â”‚\nâ”‚                                                                             â”‚\nâ”‚  3. INVOKE debug-assist                                                     â”‚\nâ”‚     â”œâ”€â†’ Provide error details                                               â”‚\nâ”‚     â”œâ”€â†’ Provide recent changes                                              â”‚\nâ”‚     â””â”€â†’ Get diagnosis and fix suggestions                                   â”‚\nâ”‚                                                                             â”‚\nâ”‚  4. FORM HYPOTHESIS                                                         â”‚\nâ”‚     â”œâ”€â†’ Most likely cause                                                   â”‚\nâ”‚     â”œâ”€â†’ Alternative causes                                                  â”‚\nâ”‚     â””â”€â†’ Verification approach                                               â”‚\nâ”‚                                                                             â”‚\nâ”‚  5. PLAN FIX                                                                â”‚\nâ”‚     â”œâ”€â†’ Minimal change to fix                                               â”‚\nâ”‚     â”œâ”€â†’ Files to modify                                                     â”‚\nâ”‚     â””â”€â†’ Verification steps                                                  â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Error Pattern Recognition\n\n| Pattern | Likely Cause | Fix Approach |\n|---------|--------------|--------------|\n| `Cannot find module 'X'` | Missing dependency | `npm install X` |\n| `Property 'X' does not exist on type 'Y'` | Type mismatch | Update type or access |\n| `Expected X but got Y` (test) | Logic error | Check assertion and implementation |\n| `Timeout of X exceeded` | Slow operation or deadlock | Optimize or increase timeout |\n| `ECONNREFUSED` | Service not running | Start service or mock |\n| `401 Unauthorized` | Auth issue | Check credentials/tokens |\n| `Circular dependency` | Import cycle | Restructure imports |\n\n## Retry Strategy\n\n### Retry Decision Tree\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                      RETRY DECISION                                          â”‚\nâ”‚                                                                             â”‚\nâ”‚  Should we retry?                                                           â”‚\nâ”‚  â”‚                                                                          â”‚\nâ”‚  â”œâ”€ Is it a security finding?                                               â”‚\nâ”‚  â”‚   â””â”€ NO: Don't auto-retry, escalate                                      â”‚\nâ”‚  â”‚                                                                          â”‚\nâ”‚  â”œâ”€ Is it the same error as last attempt?                                   â”‚\nâ”‚  â”‚   â”œâ”€ YES: Increment same-error counter                                   â”‚\nâ”‚  â”‚   â”‚   â””â”€ Same error > 2 times? â†’ Escalate                                â”‚\nâ”‚  â”‚   â””â”€ NO: Reset same-error counter                                        â”‚\nâ”‚  â”‚                                                                          â”‚\nâ”‚  â”œâ”€ Total failures < max (10)?                                              â”‚\nâ”‚  â”‚   â””â”€ NO: â†’ Escalate                                                      â”‚\nâ”‚  â”‚                                                                          â”‚\nâ”‚  â”œâ”€ Current retry count < max (3)?                                          â”‚\nâ”‚  â”‚   â”œâ”€ YES: â†’ Retry                                                        â”‚\nâ”‚  â”‚   â””â”€ NO: â†’ Escalate                                                      â”‚\nâ”‚  â”‚                                                                          â”‚\nâ”‚  â””â”€ Retry with:                                                             â”‚\nâ”‚      â”œâ”€ Diagnosis from debug-assist                                         â”‚\nâ”‚      â”œâ”€ Targeted fix                                                        â”‚\nâ”‚      â””â”€ Re-run from failed stage                                            â”‚\nâ”‚                                                                             â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Retry Backoff (External Failures)\n\nFor external service failures, use exponential backoff:\n\n```javascript\nconst backoff = {\n  initial: 1000,      // 1 second\n  multiplier: 2,\n  maxDelay: 30000,    // 30 seconds\n  maxRetries: 5\n};\n\nfunction getDelay(attempt) {\n  const delay = backoff.initial * Math.pow(backoff.multiplier, attempt);\n  return Math.min(delay, backoff.maxDelay);\n}\n\n// Attempt 0: 1s\n// Attempt 1: 2s\n// Attempt 2: 4s\n// Attempt 3: 8s\n// Attempt 4: 16s\n```\n\n## Fix Application\n\n### Fix Guidelines\n\n1. **Minimal changes only** â€” Fix the error, nothing else\n2. **Separate commit** â€” Commit fix separately from feature code\n3. **Explain the fix** â€” Commit message explains what and why\n4. **Verify thoroughly** â€” Run all checks, not just the failed one\n5. **Check for regressions** â€” Ensure fix doesn't break other tests\n\n### Fix Commit Format\n\n```\nfix({scope}): {description}\n\nError: {original error message}\nCause: {root cause}\nFix: {what was changed}\n\nAttempt: {N}/{max}\n```\n\nExample:\n```\nfix(work-order): correct type for assignedTo field\n\nError: Type 'string | null' is not assignable to type 'string'\nCause: Database returns null for unassigned orders\nFix: Made assignedTo field optional in WorkOrder interface\n\nAttempt: 1/3\n```\n\n## Escalation\n\n### When to Escalate\n\n| Condition | Escalate To |\n|-----------|-------------|\n| Max retries (3) exceeded | Human engineer |\n| Same error 3 times | Human engineer |\n| Total failures (10) exceeded | Human engineer |\n| Security finding | Security team |\n| Circular fix (A breaks B, B breaks A) | Human engineer |\n| External service down > 1 hour | Human / ops |\n| Ambiguous requirement discovered | Product owner |\n\n### Escalation Template\n\n```markdown\n## ğŸš¨ Escalation Required: [System Name]\n\n### Summary\n[One sentence description of the problem]\n\n### Error Details\n```\n[Error message and stack trace]\n```\n\n### Retry History\n| Attempt | Error | Fix Tried | Outcome |\n|---------|-------|-----------|---------|\n| 1 | [Error] | [Fix] | [Still failed] |\n| 2 | [Error] | [Fix] | [Different error] |\n| 3 | [Error] | [Fix] | [Same error] |\n\n### Analysis\n[What debug-assist determined]\n\n### Root Cause Hypothesis\n[Best guess at underlying issue]\n\n### Human Action Needed\n[Specific request]\n\n### To Resume After Resolution\n1. Fix the underlying issue\n2. Run verification: `npm test`\n3. Update loop-state.json: set `state` to `[stage]`\n4. Clear failure: set `failures.count` to `0`\n5. Run `loop resume`\n\n### Context\n- Branch: [branch]\n- Last commit: [hash]\n- Worktree: [path]\n- GitHub Issue: #[number]\n```\n\n## Recovery\n\n### After Human Fix\n\n```bash\n# 1. Verify the fix\ncd .worktrees/[system]\nnpm test\nnpm run lint\nnpm run build\n\n# 2. Update loop state\n# Edit loop-state.json:\n{\n  \"state\": \"VERIFY\",  // or wherever to resume\n  \"failures\": {\n    \"count\": 0,       // reset retry counter\n    ...\n  }\n}\n\n# 3. Resume loop\nloop resume\n```\n\n### State Recovery\n\nIf loop-state.json is corrupted:\n\n```bash\n# 1. Check git for last good state\ngit log --oneline loop-state.json\n\n# 2. Restore from commit\ngit checkout [hash] -- loop-state.json\n\n# 3. Or reconstruct from code state\n# - Check git log for last successful commits\n# - Check test results\n# - Determine current stage\n# - Manually create valid loop-state.json\n```\n\n## Failure Log\n\nMaintain failure history for learning:\n\n```json\n// failure-log.json (append-only)\n{\n  \"failures\": [\n    {\n      \"timestamp\": \"2024-01-17T10:15:00Z\",\n      \"system\": \"sys-002\",\n      \"stage\": \"VERIFY\",\n      \"error\": \"Type error in WorkOrder model\",\n      \"errorType\": \"type\",\n      \"file\": \"src/models/work-order.ts\",\n      \"line\": 15,\n      \"retries\": 1,\n      \"resolution\": \"Fixed type definition\",\n      \"resolutionTime\": 600,  // seconds\n      \"wasEscalated\": false\n    }\n  ]\n}\n```\n\nUse for:\n- Identifying common failure patterns\n- Improving error detection\n- Updating fix strategies\n- Measuring reliability\n"
    },
    {
      "name": "gate-procedures.md",
      "path": "references/gate-procedures.md",
      "content": "# Gate Procedures\n\nHow to request, check, and manage human approval gates.\n\n## Gate Types\n\n| Gate | Purpose | Trigger | Approver |\n|------|---------|---------|----------|\n| `architecture` | Validate architectural decisions | New patterns, major changes | Tech Lead |\n| `security` | Review security implications | Auth, crypto, PII handling | Security Team |\n| `database` | Review schema changes | Migrations, data changes | DBA |\n| `external` | Review third-party integrations | New API integrations | Tech Lead |\n| `deploy` | Approve production release | Every PR merge | Release Manager |\n\n## Detecting Gate Requirements\n\n### Architecture Gate\n\nRequired when:\n- New architectural pattern introduced\n- Major structural change to existing system\n- New service/component added\n- Significant dependency added\n\nDetection:\n```bash\n# Check for new patterns\ngit diff --name-only origin/main | grep -E \"(src/infrastructure|src/config|docker-compose)\"\n\n# Check for new dependencies\ngit diff origin/main -- package.json | grep '\"+' | grep -v '\"-'\n```\n\n### Security Gate\n\nRequired when:\n- Authentication/authorization changes\n- Cryptographic operations\n- PII handling\n- API security (rate limiting, input validation)\n- Secret management\n\nDetection:\n```bash\n# Check for security-related files\ngit diff --name-only origin/main | grep -iE \"(auth|security|crypto|password|token|secret)\"\n\n# Check for sensitive patterns in diff\ngit diff origin/main | grep -iE \"(password|secret|private_key|api_key)\"\n```\n\n### Database Gate\n\nRequired when:\n- Schema migrations\n- Index changes\n- Data transformations\n- Stored procedures\n\nDetection:\n```bash\n# Check for migration files\ngit diff --name-only origin/main | grep -E \"(migrations?/|schema)\"\n\n# Check for Prisma/TypeORM changes\ngit diff --name-only origin/main | grep -E \"(prisma|\\.entity\\.ts|\\.model\\.ts)\"\n```\n\n### External Gate\n\nRequired when:\n- New third-party API integration\n- Changes to existing integration\n- Webhook implementations\n\nDetection:\n```bash\n# Check for integration files\ngit diff --name-only origin/main | grep -iE \"(integration|external|webhook|api-client)\"\n\n# Check for new HTTP clients\ngit diff origin/main | grep -E \"(axios|fetch|http\\.request)\"\n```\n\n### Deploy Gate\n\nRequired: **Always for SHIP stage**\n\n## Requesting Approval\n\n### Via GitHub CLI\n\n```bash\n# 1. Create or update PR\ngh pr create --base main --head feature/system-name \\\n  --title \"feat: System Name\" \\\n  --body-file PR_DESCRIPTION.md\n\n# 2. Add gate-specific label\ngh pr edit $PR_NUMBER --add-label \"needs:security-review\"\n\n# 3. Add reviewers\ngh pr edit $PR_NUMBER --add-reviewer @security-team\n\n# 4. Post review request comment\ngh pr comment $PR_NUMBER --body \"## Security Review Requested\n\nThis PR includes the following security-relevant changes:\n\n### Changes\n- JWT token handling in \\`src/auth/token.service.ts\\`\n- Password hashing in \\`src/users/password.service.ts\\`\n\n### Security Checklist\n- [ ] Authentication properly implemented\n- [ ] Authorization checks in place\n- [ ] Input validation complete\n- [ ] No sensitive data logged\n- [ ] Secrets properly managed\n\nPlease review and approve if satisfactory.\"\n```\n\n### Gate Request Templates\n\n#### Architecture Review Request\n\n```markdown\n## Architecture Review Requested\n\n### Summary\n[What architectural changes are being made]\n\n### Changes\n- [Change 1]\n- [Change 2]\n\n### Architectural Decisions\n| Decision | Choice | Rationale |\n|----------|--------|-----------|\n| [Decision] | [Choice] | [Why] |\n\n### Impact\n- [Component affected]\n- [Integration points]\n\n### Questions for Reviewer\n- [Specific question 1]\n- [Specific question 2]\n\n### Checklist\n- [ ] Follows established patterns\n- [ ] Documented in ADR (if significant)\n- [ ] Backward compatible (or migration plan)\n- [ ] Performance implications considered\n```\n\n#### Security Review Request\n\n```markdown\n## Security Review Requested\n\n### Summary\n[What security-relevant changes are being made]\n\n### Security Changes\n| Area | Change | Risk Level |\n|------|--------|------------|\n| [Auth] | [Change] | [High/Med/Low] |\n\n### Security Checklist\n- [ ] Authentication implemented correctly\n- [ ] Authorization checks present\n- [ ] Input validation complete\n- [ ] Output encoding applied\n- [ ] Secrets not hardcoded\n- [ ] Sensitive data not logged\n- [ ] Rate limiting in place (if API)\n- [ ] HTTPS enforced\n\n### Threat Model\n[Any identified threats and mitigations]\n\n### Questions for Reviewer\n- [Specific security question]\n```\n\n#### Database Review Request\n\n```markdown\n## Database Review Requested\n\n### Summary\n[What database changes are being made]\n\n### Migration Details\n| Migration | Type | Tables Affected |\n|-----------|------|-----------------|\n| [Name] | [CREATE/ALTER/DROP] | [Tables] |\n\n### Schema Changes\n```sql\n-- Key changes\n[SQL snippet]\n```\n\n### Data Impact\n- Records affected: [estimate]\n- Downtime required: [yes/no]\n- Rollback plan: [description]\n\n### Performance Impact\n- [ ] Indexes added for new queries\n- [ ] Query plans reviewed\n- [ ] No N+1 issues introduced\n\n### Checklist\n- [ ] Migration is reversible\n- [ ] Migration tested locally\n- [ ] Backup plan documented\n- [ ] Runbook updated\n```\n\n## Checking Approval Status\n\n### Via GitHub CLI\n\n```bash\n# Check PR reviews\ngh pr view $PR_NUMBER --json reviews\n\n# Check specific review status\ngh pr view $PR_NUMBER --json reviews --jq '.reviews[] | select(.author.login==\"security-team\") | .state'\n\n# Check PR checks\ngh pr checks $PR_NUMBER\n```\n\n### Via API\n\n```bash\n# Get review status\ncurl -H \"Authorization: token $GITHUB_TOKEN\" \\\n  https://api.github.com/repos/org/repo/pulls/$PR_NUMBER/reviews\n\n# Parse for approvals\ncurl -s -H \"Authorization: token $GITHUB_TOKEN\" \\\n  https://api.github.com/repos/org/repo/pulls/$PR_NUMBER/reviews | \\\n  jq '[.[] | select(.state==\"APPROVED\")] | length'\n```\n\n### Polling Strategy\n\n```javascript\nasync function waitForApproval(prNumber, requiredApprovers, timeout = 3600000) {\n  const startTime = Date.now();\n  const pollInterval = 60000; // 1 minute\n  \n  while (Date.now() - startTime < timeout) {\n    const reviews = await getReviews(prNumber);\n    const approvals = reviews.filter(r => r.state === 'APPROVED');\n    \n    const hasRequired = requiredApprovers.every(approver =>\n      approvals.some(a => a.user.login === approver || a.user.team === approver)\n    );\n    \n    if (hasRequired) {\n      return { approved: true, reviews: approvals };\n    }\n    \n    // Check for rejections\n    const rejections = reviews.filter(r => r.state === 'CHANGES_REQUESTED');\n    if (rejections.length > 0) {\n      return { approved: false, rejected: true, reviews: rejections };\n    }\n    \n    await sleep(pollInterval);\n  }\n  \n  return { approved: false, timeout: true };\n}\n```\n\n## Handling Approval Results\n\n### On Approval\n\n```bash\n# Update loop state\njq '.gates.security.status = \"approved\" | \n    .gates.security.approvedAt = \"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'\" |\n    .gates.security.approvedBy = \"security-team\"' loop-state.json > tmp.json && mv tmp.json loop-state.json\n\n# Add checkpoint\njq '.checkpoints += [{\"type\": \"approval\", \"message\": \"Security review approved\", \"at\": \"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'\"}]' loop-state.json > tmp.json && mv tmp.json loop-state.json\n\n# Continue loop\nloop resume\n```\n\n### On Rejection\n\n```bash\n# Log rejection\ngh pr view $PR_NUMBER --json reviews --jq '.reviews[] | select(.state==\"CHANGES_REQUESTED\") | .body'\n\n# Transition to addressing feedback\n# Update loop state to go back to IMPLEMENT or appropriate stage\n\njq '.state = \"IMPLEMENT\" | \n    .failures.history += [{\"stage\": \"gate-rejection\", \"error\": \"Changes requested by reviewer\", \"timestamp\": \"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'\"}]' loop-state.json > tmp.json && mv tmp.json loop-state.json\n```\n\n### On Timeout\n\n```bash\n# Escalate\necho \"Gate approval timed out after 1 hour\"\necho \"PR: $PR_NUMBER\"\necho \"Gate: security\"\necho \"Requested: $(jq -r '.gates.security.requestedAt' loop-state.json)\"\n\n# Notify via Slack/email if configured\n# Transition to BLOCKED\njq '.state = \"BLOCKED\" | .blockedReason = \"Gate approval timeout: security\"' loop-state.json > tmp.json && mv tmp.json loop-state.json\n```\n\n## Gate State Management\n\n### In loop-state.json\n\n```json\n{\n  \"gates\": {\n    \"architecture\": {\n      \"required\": true,\n      \"status\": \"approved\",\n      \"requestedAt\": \"2024-01-17T08:00:00Z\",\n      \"approvedBy\": \"tech-lead@company.com\",\n      \"approvedAt\": \"2024-01-17T09:30:00Z\",\n      \"notes\": \"Approved pattern for event sourcing\"\n    },\n    \"security\": {\n      \"required\": true,\n      \"status\": \"requested\",\n      \"requestedAt\": \"2024-01-17T10:00:00Z\"\n    },\n    \"database\": {\n      \"required\": false,\n      \"status\": \"not-applicable\"\n    },\n    \"external\": {\n      \"required\": false,\n      \"status\": \"not-applicable\"\n    },\n    \"deploy\": {\n      \"required\": true,\n      \"status\": \"pending\"\n    }\n  }\n}\n```\n\n### Status Values\n\n| Status | Meaning |\n|--------|---------|\n| `pending` | Gate not yet evaluated |\n| `not-applicable` | Gate determined not required |\n| `requested` | Approval request sent |\n| `approved` | Approval received |\n| `rejected` | Changes requested |\n\n## Notifications\n\n### Slack Notification (Optional)\n\n```bash\n# Send gate request notification\ncurl -X POST -H 'Content-type: application/json' \\\n  --data '{\n    \"channel\": \"#pr-reviews\",\n    \"text\": \"ğŸ”’ Security review requested\",\n    \"attachments\": [{\n      \"color\": \"warning\",\n      \"fields\": [\n        {\"title\": \"PR\", \"value\": \"<'$PR_URL'|#'$PR_NUMBER'>\", \"short\": true},\n        {\"title\": \"System\", \"value\": \"'$SYSTEM_NAME'\", \"short\": true},\n        {\"title\": \"Changes\", \"value\": \"Auth token handling, password hashing\"}\n      ]\n    }]\n  }' \\\n  $SLACK_WEBHOOK_URL\n```\n\n### Email Template\n\n```\nSubject: [Action Required] Security Review: PR #123 - Work Order Service\n\nA security review is required for the following PR:\n\nPR: #123 - feat: Work Order Service authentication\nBranch: feature/system-work-orders\nAuthor: agent-001\n\nSecurity-relevant changes:\n- JWT token handling (src/auth/token.service.ts)\n- Password hashing (src/users/password.service.ts)\n\nPlease review: https://github.com/org/repo/pull/123\n\nThis is blocking deployment until approved.\n```\n"
    }
  ],
  "tags": [
    "meta",
    "orchestration",
    "control"
  ],
  "dependsOn": []
}