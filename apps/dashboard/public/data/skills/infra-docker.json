{
  "id": "infra-docker",
  "name": "infra-docker",
  "version": "1.0.0",
  "description": "Create Docker configuration with multi-stage builds, docker-compose for local development, and container optimization.",
  "phase": "IMPLEMENT",
  "category": "infra",
  "content": "# Infra Docker\n\nCreate Docker configuration for containerized deployment and local development.\n\n## When to Use\n\n- **Containerizing an application** — Creating Dockerfile for deployment\n- **Local development** — Setting up docker-compose for multi-service dev\n- **CI/CD integration** — Building images for automated pipelines\n- When you say: \"dockerize\", \"create Dockerfile\", \"container setup\"\n\n## Required Deliverables\n\n| Deliverable | Location | Condition |\n|-------------|----------|-----------|\n| `Dockerfile` | Project root | Always |\n| `docker-compose.yml` | Project root | When multiple services |\n| `.dockerignore` | Project root | Always |\n\n## Core Concept\n\nDocker setup answers: **\"How do we package this application for consistent, reproducible deployment?\"**\n\n```\nSource Code → Multi-stage Build → Optimized Image → Container Registry → Deployment\n```\n\n## Multi-Stage Dockerfile (Node.js)\n\n```dockerfile\n# Build stage\nFROM node:20-alpine AS builder\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci\nCOPY . .\nRUN npm run build\n\n# Production stage\nFROM node:20-alpine AS production\nWORKDIR /app\nCOPY --from=builder /app/dist ./dist\nCOPY --from=builder /app/package*.json ./\nRUN npm ci --omit=dev && npm cache clean --force\nUSER node\nEXPOSE 3000\nCMD [\"node\", \"dist/index.js\"]\n```\n\n## Docker Compose (Local Development)\n\n```yaml\nservices:\n  app:\n    build: .\n    ports:\n      - \"3000:3000\"\n    environment:\n      - DATABASE_URL=postgresql://postgres:postgres@db:5432/app\n    depends_on:\n      db:\n        condition: service_healthy\n    volumes:\n      - ./src:/app/src\n\n  db:\n    image: postgres:16-alpine\n    environment:\n      POSTGRES_PASSWORD: postgres\n      POSTGRES_DB: app\n    ports:\n      - \"5432:5432\"\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U postgres\"]\n      interval: 5s\n      timeout: 5s\n      retries: 5\n    volumes:\n      - pgdata:/var/lib/postgresql/data\n\nvolumes:\n  pgdata:\n```\n\n## .dockerignore\n\n```\nnode_modules\ndist\n.git\n.env*\n*.md\n.vscode\n.idea\ncoverage\n```\n\n## Image Optimization\n\n| Technique | Impact | How |\n|-----------|--------|-----|\n| Alpine base | -80% image size | `node:20-alpine` instead of `node:20` |\n| Multi-stage | -60% final size | Separate build and production stages |\n| .dockerignore | Faster builds | Exclude non-essential files |\n| Layer ordering | Better caching | Copy package.json before source code |\n| Non-root user | Security | `USER node` in production stage |\n\n## Health Checks\n\n```dockerfile\nHEALTHCHECK --interval=30s --timeout=3s --retries=3 \\\n  CMD wget -qO- http://localhost:3000/health || exit 1\n```\n\n## Checklist\n\n- [ ] Multi-stage build separates build and runtime\n- [ ] Alpine base image used\n- [ ] .dockerignore excludes node_modules, .git, .env\n- [ ] Non-root user in production stage\n- [ ] Health check configured\n- [ ] docker-compose.yml for local multi-service development\n\n## Relationship to Other Skills\n\n| Skill | Relationship |\n|-------|--------------|\n| `scaffold` | Project structure informs Dockerfile paths |\n| `distribute` | Docker images published to GHCR via distribute pipeline |\n| `deploy` | Containers deployed to production via deploy strategies |\n| `infra-devenv` | docker-compose provides local dev environment |\n\n## Key Principles\n\n**Multi-stage builds.** Never ship build tools in production images.\n\n**Alpine base.** Smaller images mean faster deploys and less attack surface.\n\n**Non-root user.** Always run as non-root in production containers.\n\n**Layer caching.** Order Dockerfile commands from least to most frequently changing.",
  "references": [],
  "tags": [
    "infrastructure",
    "docker",
    "containerization",
    "deployment",
    "images"
  ],
  "dependsOn": [
    "scaffold"
  ]
}