{
  "id": "notification-tester",
  "name": "notification-tester",
  "version": "1.0.0",
  "description": "Tests notification delivery for async operation. Verifies that notifications reach the user across all configured channels.",
  "phase": "VERIFY",
  "category": "operations",
  "content": "# Notification Tester\n\nTests that notifications will reach the user during async operation.\n\n## When to Use\n\n- During async-loop VERIFY phase\n- After Slack validation passes\n- To confirm end-to-end notification delivery\n\n## What It Tests\n\n### Notification Types\n\n| Type | Purpose | Test |\n|------|---------|------|\n| Gate waiting | Alert user to approve gate | Send mock gate notification |\n| Loop complete | Inform of completion | Send mock completion notification |\n| Error alert | Warn of problems | Send mock error notification |\n| Status update | Progress updates | Send mock status notification |\n\n### Delivery Channels\n\n| Channel | Test Method |\n|---------|-------------|\n| Slack | Message with buttons |\n| Terminal | Console output + OS notification |\n\n## Workflow\n\n### Step 1: Get Enabled Channels\n\n```typescript\nconst channels = await messagingService.getEnabledChannels();\n// ['slack', 'terminal']\n```\n\n### Step 2: Test Each Channel\n\n```typescript\nfor (const channel of channels) {\n  const result = await testChannel(channel);\n  results[channel] = result;\n}\n```\n\n### Step 3: Send Test Gate Notification\n\nSimulates a gate waiting notification:\n\n```typescript\nconst gateNotification = await messagingService.notifyGateWaiting({\n  executionId: 'test-execution',\n  gate: {\n    id: 'test-gate',\n    name: 'Test Gate',\n    type: 'human'\n  },\n  context: {\n    loop: 'test-loop',\n    phase: 'TEST',\n    waiting_since: new Date().toISOString()\n  },\n  test: true // Marks as test, may be styled differently\n});\n```\n\n### Step 4: Verify @mention\n\nFor Slack, verify user is @mentioned:\n\n```typescript\nconst mentionWorking = gateNotification.text?.includes(`<@${userId}>`);\n```\n\n### Step 5: Test Response Handling\n\nVerify that clicking buttons triggers correct handling:\n\n```typescript\n// This is tested by slack-validator interactive test\n// Here we just verify the handlers are registered\nconst handlers = messagingService.getRegisteredHandlers();\nconst requiredHandlers = ['approve_gate', 'reject_gate', 'show_status'];\n\nfor (const handler of requiredHandlers) {\n  if (!handlers.includes(handler)) {\n    results.handlers.missing.push(handler);\n  }\n}\n```\n\n### Step 6: Report Results\n\n```json\n{\n  \"notification_test\": {\n    \"tested_at\": \"ISO-timestamp\",\n    \"channels_tested\": [\"slack\", \"terminal\"],\n    \"results\": {\n      \"slack\": {\n        \"gate_notification\": \"delivered\",\n        \"mention_working\": true,\n        \"buttons_rendered\": true\n      },\n      \"terminal\": {\n        \"gate_notification\": \"displayed\",\n        \"os_notification\": \"sent\"\n      }\n    },\n    \"handlers_registered\": [\"approve_gate\", \"reject_gate\", \"show_status\"],\n    \"overall_valid\": true\n  }\n}\n```\n\n## Output\n\nUpdates execution state with test results.\n\n## Required Deliverables\n\n| Deliverable | Location | Condition |\n|-------------|----------|-----------|\n| Test report | Execution logs | Always |\n\n## Notification Formats\n\n### Gate Waiting (Slack)\n\n```\n@user Gate Approval Needed\n\nLoop: engineering-loop\nPhase: REVIEW\nGate: code-review-gate\n\nWaiting since: 2 minutes ago\n\n[Approve] [Reject] [View Details]\n```\n\n### Loop Complete (Slack)\n\n```\nLoop Completed Successfully\n\nLoop: engineering-loop\nDuration: 2h 15m\nOutcome: All gates passed\n\n[View Summary] [Start Next]\n```\n\n## References\n\n- [notification-formats.md](references/notification-formats.md) — All notification format specifications",
  "references": [
    {
      "name": "notification-formats.md",
      "path": "references/notification-formats.md",
      "content": "# Notification Formats\n\nSpecifications for all notification types.\n\n## Gate Waiting Notification\n\n### Slack Format\n\n```json\n{\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \"Gate Approval Needed\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Loop:* engineering-loop\\n*Phase:* REVIEW\\n*Gate:* code-review-gate\"\n      }\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"Waiting since: 2 minutes ago\"\n        }\n      ]\n    },\n    {\n      \"type\": \"actions\",\n      \"elements\": [\n        {\n          \"type\": \"button\",\n          \"text\": { \"type\": \"plain_text\", \"text\": \"Approve\" },\n          \"style\": \"primary\",\n          \"action_id\": \"approve_gate\",\n          \"value\": \"exec-123:code-review-gate\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": { \"type\": \"plain_text\", \"text\": \"Reject\" },\n          \"style\": \"danger\",\n          \"action_id\": \"reject_gate\",\n          \"value\": \"exec-123:code-review-gate\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": { \"type\": \"plain_text\", \"text\": \"View Details\" },\n          \"action_id\": \"show_details\",\n          \"value\": \"exec-123\"\n        }\n      ]\n    }\n  ],\n  \"text\": \"<@USER_ID> Gate Approval Needed\"\n}\n```\n\n### Terminal Format\n\n```\n╔══════════════════════════════════════════════════════════╗\n║  GATE APPROVAL NEEDED                                    ║\n╠══════════════════════════════════════════════════════════╣\n║  Loop: engineering-loop                                  ║\n║  Phase: REVIEW                                           ║\n║  Gate: code-review-gate                                  ║\n║                                                          ║\n║  Waiting since: 2 minutes ago                            ║\n║                                                          ║\n║  Run: approved / rejected / show status                  ║\n╚══════════════════════════════════════════════════════════╝\n```\n\n## Loop Complete Notification\n\n### Slack Format\n\n```json\n{\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \"Loop Completed\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Loop:* engineering-loop\\n*Duration:* 2h 15m\\n*Outcome:* Success\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Deliverables:*\\n• SPEC.md\\n• Implementation complete\\n• Tests passing\"\n      }\n    },\n    {\n      \"type\": \"actions\",\n      \"elements\": [\n        {\n          \"type\": \"button\",\n          \"text\": { \"type\": \"plain_text\", \"text\": \"View Summary\" },\n          \"action_id\": \"show_summary\",\n          \"value\": \"exec-123\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": { \"type\": \"plain_text\", \"text\": \"Start Next\" },\n          \"style\": \"primary\",\n          \"action_id\": \"start_next\",\n          \"value\": \"queue\"\n        }\n      ]\n    }\n  ],\n  \"text\": \"Loop engineering-loop completed successfully\"\n}\n```\n\n## Error Notification\n\n### Slack Format\n\n```json\n{\n  \"blocks\": [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": \"Execution Error\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*Loop:* engineering-loop\\n*Phase:* IMPLEMENT\\n*Error:* Test failures detected\"\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"```\\n5 tests failed\\nSee execution logs for details\\n```\"\n      }\n    },\n    {\n      \"type\": \"actions\",\n      \"elements\": [\n        {\n          \"type\": \"button\",\n          \"text\": { \"type\": \"plain_text\", \"text\": \"View Logs\" },\n          \"action_id\": \"show_logs\",\n          \"value\": \"exec-123\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": { \"type\": \"plain_text\", \"text\": \"Retry\" },\n          \"action_id\": \"retry_phase\",\n          \"value\": \"exec-123:IMPLEMENT\"\n        },\n        {\n          \"type\": \"button\",\n          \"text\": { \"type\": \"plain_text\", \"text\": \"Abort\" },\n          \"style\": \"danger\",\n          \"action_id\": \"abort_execution\",\n          \"value\": \"exec-123\"\n        }\n      ]\n    }\n  ],\n  \"text\": \"<@USER_ID> Execution error in engineering-loop\"\n}\n```\n\n## Status Update Notification\n\n### Slack Format\n\n```json\n{\n  \"blocks\": [\n    {\n      \"type\": \"section\",\n      \"text\": {\n        \"type\": \"mrkdwn\",\n        \"text\": \"Phase *IMPLEMENT* completed. Moving to *TEST*.\"\n      }\n    },\n    {\n      \"type\": \"context\",\n      \"elements\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": \"Progress: 3/6 phases complete\"\n        }\n      ]\n    }\n  ]\n}\n```\n\n## @Mention Rules\n\n| Notification Type | @Mention |\n|-------------------|----------|\n| Gate waiting | Always |\n| Error | Always |\n| Loop complete | Optional |\n| Status update | Never |\n"
    }
  ],
  "tags": [
    "async",
    "notifications",
    "testing",
    "communication"
  ],
  "dependsOn": [
    "slack-validator"
  ]
}