{
  "id": "state-loader",
  "name": "state-loader",
  "version": "1.0.0",
  "description": "Loads and validates system state for async operation. Reads memory files, execution history, and current configuration to establish baseline context.",
  "phase": "INIT",
  "category": "operations",
  "content": "# State Loader\n\nLoads current system state from all persistent stores to establish context for async operation.\n\n## When to Use\n\n- At the start of async-loop to establish baseline\n- When resuming from a previous async session\n- When system state needs validation before autonomous operation\n\n## What It Loads\n\n### Memory State\n\n| Source | Location | Contains |\n|--------|----------|----------|\n| Orchestrator memory | `memory/orchestrator.json` | Global patterns, decisions, calibration |\n| Async state | `memory/async-state.json` | Previous async session state (if exists) |\n| Execution history | `data/executions/` | Recent loop execution records |\n\n### Configuration State\n\n| Source | Location | Contains |\n|--------|----------|----------|\n| Proactive messaging | `data/proactive-messaging/` | Channel configurations, pending interactions |\n| Autonomous config | `data/autonomous/` | Executor state, tick history |\n\n### Git State\n\n- Current branch\n- Uncommitted changes\n- Last commit information\n- Remote sync status\n\n## Workflow\n\n### Step 1: Load Memory Files\n\n```typescript\nconst memoryState = {\n  orchestrator: await loadJSON('memory/orchestrator.json'),\n  async: await loadJSON('memory/async-state.json'), // may not exist\n  patterns: memory.patterns || [],\n  decisions: memory.decisions || [],\n  calibration: memory.calibration || {}\n};\n```\n\n### Step 2: Load Execution History\n\nQuery recent executions:\n- Last 10 completed executions\n- Any in-progress executions\n- Failed executions needing attention\n\n### Step 3: Load Configuration\n\n```typescript\nconst config = {\n  messaging: await loadMessagingConfig(),\n  autonomous: await loadAutonomousConfig(),\n  slack: await loadSlackConfig()\n};\n```\n\n### Step 4: Assess Git State\n\n```bash\ngit status --porcelain\ngit log -1 --format=\"%h %s (%cr)\"\ngit rev-list --left-right --count origin/main...HEAD\n```\n\n### Step 5: Validate Integrity\n\nCheck for:\n- Corrupted JSON files\n- Missing required configuration\n- Stale state (>24 hours old)\n- Incomplete previous sessions\n\n## Output\n\nProduces `memory/async-state.json`:\n\n```json\n{\n  \"loaded_at\": \"ISO-timestamp\",\n  \"memory\": {\n    \"patterns_count\": 15,\n    \"decisions_count\": 8,\n    \"calibration_version\": \"1.2.0\"\n  },\n  \"executions\": {\n    \"recent\": 10,\n    \"in_progress\": 0,\n    \"failed_unresolved\": 1\n  },\n  \"config\": {\n    \"messaging_enabled\": true,\n    \"slack_connected\": true,\n    \"autonomous_enabled\": true\n  },\n  \"git\": {\n    \"branch\": \"main\",\n    \"uncommitted\": false,\n    \"behind_remote\": 0,\n    \"ahead_remote\": 0\n  },\n  \"validation\": {\n    \"valid\": true,\n    \"warnings\": [],\n    \"errors\": []\n  }\n}\n```\n\n## Required Deliverables\n\n| Deliverable | Location | Condition |\n|-------------|----------|-----------|\n| Async state file | `memory/async-state.json` | Always |\n\n## Error Handling\n\n| Error | Recovery |\n|-------|----------|\n| Missing memory files | Initialize with defaults |\n| Corrupted JSON | Report error, abort async prep |\n| Missing Slack config | Warn, continue without Slack |\n| Git in conflict state | Abort, require manual resolution |\n\n## References\n\n- [state-schema.md](references/state-schema.md) â€” Full schema for async-state.json",
  "references": [
    {
      "name": "state-schema.md",
      "path": "references/state-schema.md",
      "content": "# Async State Schema\n\nComplete schema for `memory/async-state.json`.\n\n## Root Object\n\n```json\n{\n  \"loaded_at\": \"string (ISO 8601 timestamp)\",\n  \"version\": \"string (schema version)\",\n  \"memory\": { ... },\n  \"executions\": { ... },\n  \"config\": { ... },\n  \"git\": { ... },\n  \"validation\": { ... }\n}\n```\n\n## Memory Block\n\n```json\n{\n  \"memory\": {\n    \"patterns_count\": \"number\",\n    \"patterns_recent\": \"number (last 7 days)\",\n    \"decisions_count\": \"number\",\n    \"decisions_recent\": \"number (last 7 days)\",\n    \"calibration_version\": \"string\",\n    \"calibration_accuracy\": \"number (0-1)\",\n    \"last_handoff\": \"string (ISO timestamp) | null\"\n  }\n}\n```\n\n## Executions Block\n\n```json\n{\n  \"executions\": {\n    \"recent\": \"number (last 10)\",\n    \"in_progress\": \"number\",\n    \"failed_unresolved\": \"number\",\n    \"last_completed\": {\n      \"id\": \"string\",\n      \"loop\": \"string\",\n      \"completed_at\": \"string (ISO timestamp)\",\n      \"outcome\": \"success | failed | abandoned\"\n    },\n    \"pending_gates\": [\n      {\n        \"execution_id\": \"string\",\n        \"gate_id\": \"string\",\n        \"waiting_since\": \"string (ISO timestamp)\"\n      }\n    ]\n  }\n}\n```\n\n## Config Block\n\n```json\n{\n  \"config\": {\n    \"messaging_enabled\": \"boolean\",\n    \"messaging_channels\": [\"terminal\", \"slack\"],\n    \"slack_connected\": \"boolean\",\n    \"slack_channel_id\": \"string | null\",\n    \"autonomous_enabled\": \"boolean\",\n    \"autonomous_tick_interval\": \"number (ms)\",\n    \"autonomous_max_parallel\": \"number\"\n  }\n}\n```\n\n## Git Block\n\n```json\n{\n  \"git\": {\n    \"branch\": \"string\",\n    \"uncommitted\": \"boolean\",\n    \"uncommitted_files\": \"number\",\n    \"behind_remote\": \"number\",\n    \"ahead_remote\": \"number\",\n    \"last_commit\": {\n      \"hash\": \"string (short)\",\n      \"message\": \"string\",\n      \"time_ago\": \"string\"\n    },\n    \"conflict_state\": \"boolean\"\n  }\n}\n```\n\n## Validation Block\n\n```json\n{\n  \"validation\": {\n    \"valid\": \"boolean\",\n    \"warnings\": [\n      {\n        \"code\": \"string\",\n        \"message\": \"string\",\n        \"recoverable\": \"boolean\"\n      }\n    ],\n    \"errors\": [\n      {\n        \"code\": \"string\",\n        \"message\": \"string\",\n        \"blocking\": \"boolean\"\n      }\n    ]\n  }\n}\n```\n\n## Warning Codes\n\n| Code | Meaning |\n|------|---------|\n| `STALE_STATE` | Previous async state >24 hours old |\n| `MISSING_SLACK` | Slack not configured |\n| `LOW_CALIBRATION` | Calibration accuracy <70% |\n| `PENDING_GATES` | Gates waiting for approval |\n\n## Error Codes\n\n| Code | Meaning | Blocking |\n|------|---------|----------|\n| `CORRUPTED_MEMORY` | Memory JSON invalid | Yes |\n| `GIT_CONFLICT` | Git in conflict state | Yes |\n| `NO_EXECUTIONS` | No execution history | No |\n| `MISSING_CONFIG` | Required config missing | Depends |\n"
    }
  ],
  "tags": [
    "async",
    "state",
    "initialization",
    "context",
    "memory"
  ],
  "dependsOn": []
}