# Decision Trees

Visual flowcharts for loop controller decisions.

## Main Decision Loop

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MAIN DECISION LOOP                                      │
│                                                                             │
│  START                                                                      │
│    │                                                                        │
│    ▼                                                                        │
│  ┌─────────────────────────┐                                                │
│  │ Load loop-state.json    │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│              ▼                                                              │
│  ┌─────────────────────────┐     YES    ┌─────────────────────┐            │
│  │ Is state == BLOCKED?    │───────────▶│ Return: WAIT_HUMAN  │            │
│  └───────────┬─────────────┘            └─────────────────────┘            │
│              │ NO                                                           │
│              ▼                                                              │
│  ┌─────────────────────────┐     YES    ┌─────────────────────┐            │
│  │ Is state == COMPLETE?   │───────────▶│ Return: DONE        │            │
│  └───────────┬─────────────┘            └─────────────────────┘            │
│              │ NO                                                           │
│              ▼                                                              │
│  ┌─────────────────────────┐     YES    ┌─────────────────────┐            │
│  │ Is state == FAILED?     │───────────▶│ Go to RETRY DECISION│            │
│  └───────────┬─────────────┘            └─────────────────────┘            │
│              │ NO                                                           │
│              ▼                                                              │
│  ┌─────────────────────────┐     YES    ┌─────────────────────┐            │
│  │ Is gate pending?        │───────────▶│ Return: WAIT_GATE   │            │
│  └───────────┬─────────────┘            └─────────────────────┘            │
│              │ NO                                                           │
│              ▼                                                              │
│  ┌─────────────────────────┐                                                │
│  │ Get next state          │                                                │
│  │ Get skill for state     │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│              ▼                                                              │
│  ┌─────────────────────────┐                                                │
│  │ Return: EXECUTE_SKILL   │                                                │
│  │ { state, skill }        │                                                │
│  └─────────────────────────┘                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Retry Decision

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      RETRY DECISION                                          │
│                                                                             │
│  FAILED STATE                                                               │
│    │                                                                        │
│    ▼                                                                        │
│  ┌─────────────────────────┐     YES    ┌─────────────────────┐            │
│  │ Is security finding?    │───────────▶│ Return: ESCALATE    │            │
│  └───────────┬─────────────┘            │ (never auto-retry)  │            │
│              │ NO                        └─────────────────────┘            │
│              ▼                                                              │
│  ┌─────────────────────────┐     YES    ┌─────────────────────┐            │
│  │ Same error 3x?          │───────────▶│ Return: ESCALATE    │            │
│  └───────────┬─────────────┘            │ (same error stuck)  │            │
│              │ NO                        └─────────────────────┘            │
│              ▼                                                              │
│  ┌─────────────────────────┐     YES    ┌─────────────────────┐            │
│  │ Total failures > 10?    │───────────▶│ Return: ESCALATE    │            │
│  └───────────┬─────────────┘            │ (too many failures) │            │
│              │ NO                        └─────────────────────┘            │
│              ▼                                                              │
│  ┌─────────────────────────┐     YES    ┌─────────────────────┐            │
│  │ Retries >= 3?           │───────────▶│ Return: ESCALATE    │            │
│  └───────────┬─────────────┘            │ (max retries)       │            │
│              │ NO                        └─────────────────────┘            │
│              ▼                                                              │
│  ┌─────────────────────────┐                                                │
│  │ Return: RETRY           │                                                │
│  │ { stage, diagnosis }    │                                                │
│  └─────────────────────────┘                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Gate Check Decision

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      GATE CHECK                                              │
│                                                                             │
│  ENTERING NEW STATE                                                         │
│    │                                                                        │
│    ▼                                                                        │
│  ┌─────────────────────────┐                                                │
│  │ Analyze changes in      │                                                │
│  │ current state           │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│              ▼                                                              │
│  ┌─────────────────────────┐     YES    ┌─────────────────────┐            │
│  │ Has arch patterns?      │───────────▶│ architecture = REQ  │            │
│  └───────────┬─────────────┘            └───────────┬─────────┘            │
│              │ NO                                   │                       │
│              ▼                                      │                       │
│  ┌─────────────────────────┐     YES    ┌──────────▼──────────┐            │
│  │ Has security changes?   │───────────▶│ security = REQ      │            │
│  └───────────┬─────────────┘            └───────────┬─────────┘            │
│              │ NO                                   │                       │
│              ▼                                      │                       │
│  ┌─────────────────────────┐     YES    ┌──────────▼──────────┐            │
│  │ Has schema changes?     │───────────▶│ database = REQ      │            │
│  └───────────┬─────────────┘            └───────────┬─────────┘            │
│              │ NO                                   │                       │
│              ▼                                      │                       │
│  ┌─────────────────────────┐     YES    ┌──────────▼──────────┐            │
│  │ Has external APIs?      │───────────▶│ external = REQ      │            │
│  └───────────┬─────────────┘            └───────────┬─────────┘            │
│              │ NO                                   │                       │
│              ▼                                      │                       │
│  ┌─────────────────────────┐     YES    ┌──────────▼──────────┐            │
│  │ State == REVIEW?        │───────────▶│ deploy = REQ        │            │
│  └───────────┬─────────────┘            └───────────┬─────────┘            │
│              │ NO                                   │                       │
│              ▼                                      ▼                       │
│  ┌─────────────────────────────────────────────────────────────┐           │
│  │                 Check required gates                         │           │
│  └───────────────────────────┬─────────────────────────────────┘           │
│                              │                                              │
│              ┌───────────────┴───────────────┐                             │
│              ▼                               ▼                              │
│  ┌─────────────────────┐         ┌─────────────────────┐                   │
│  │ All approved?       │         │ Pending gates exist │                   │
│  │ Continue execution  │         │ Wait for approval   │                   │
│  └─────────────────────┘         └─────────────────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## State Transition Decision

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   STATE TRANSITION                                           │
│                                                                             │
│  CURRENT STATE                                                              │
│    │                                                                        │
│    ├── INIT ─────────────────────────────────────────▶ SCAFFOLD             │
│    │                                                                        │
│    ├── SCAFFOLD ─────────────────────────────────────▶ IMPLEMENT            │
│    │                                                                        │
│    ├── IMPLEMENT ────────────────────────────────────▶ TEST                 │
│    │                                                                        │
│    ├── TEST ─────────────────────────────────────────▶ VERIFY               │
│    │                                                                        │
│    ├── VERIFY ──┬── More capabilities? ──────────────▶ IMPLEMENT            │
│    │            └── All done ────────────────────────▶ VALIDATE             │
│    │                                                                        │
│    ├── VALIDATE ─────────────────────────────────────▶ DOCUMENT             │
│    │                                                                        │
│    ├── DOCUMENT ─────────────────────────────────────▶ REVIEW               │
│    │                                                                        │
│    ├── REVIEW ───────────────────────────────────────▶ SHIP                 │
│    │                                                                        │
│    ├── SHIP ────┬── PR merged ───────────────────────▶ COMPLETE             │
│    │            └── Waiting ─────────────────────────▶ SHIP (poll)          │
│    │                                                                        │
│    └── COMPLETE ─────────────────────────────────────▶ (terminal)           │
│                                                                             │
│                                                                             │
│    ANY STATE ───┬── Check fails ─────────────────────▶ FAILED               │
│                 └── External error ──────────────────▶ FAILED               │
│                                                                             │
│    FAILED ──────┬── Retries left ────────────────────▶ RETRY → (prev state) │
│                 └── Max retries ─────────────────────▶ BLOCKED              │
│                                                                             │
│    BLOCKED ─────── Human resolves ───────────────────▶ (any state)          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Capability Loop

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   CAPABILITY LOOP                                            │
│                                                                             │
│  START IMPLEMENTATION                                                       │
│    │                                                                        │
│    ▼                                                                        │
│  ┌─────────────────────────┐                                                │
│  │ Get next capability     │                                                │
│  │ from remaining[]        │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│              ▼                                                              │
│  ┌─────────────────────────┐                                                │
│  │ IMPLEMENT capability    │◀─────────────────────────┐                     │
│  │ (invoke implement)      │                          │                     │
│  └───────────┬─────────────┘                          │                     │
│              │                                        │                     │
│              ▼                                        │                     │
│  ┌─────────────────────────┐                          │                     │
│  │ TEST capability         │                          │                     │
│  │ (invoke test-generation)│                          │                     │
│  └───────────┬─────────────┘                          │                     │
│              │                                        │                     │
│              ▼                                        │                     │
│  ┌─────────────────────────┐                          │                     │
│  │ VERIFY capability       │                          │                     │
│  │ (invoke code-verify)    │                          │                     │
│  └───────────┬─────────────┘                          │                     │
│              │                                        │                     │
│    ┌─────────┴─────────┐                              │                     │
│    ▼                   ▼                              │                     │
│  PASS               FAIL                              │                     │
│    │                   │                              │                     │
│    │                   ▼                              │                     │
│    │         ┌─────────────────────────┐             │                     │
│    │         │ Retry with debug-assist │─────────────┘                     │
│    │         └─────────────────────────┘                                    │
│    │                                                                        │
│    ▼                                                                        │
│  ┌─────────────────────────┐                                                │
│  │ Commit capability       │                                                │
│  │ Move to completed[]     │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│              ▼                                                              │
│  ┌─────────────────────────┐     YES                                        │
│  │ More capabilities?      │────────────▶ (loop back to IMPLEMENT)          │
│  └───────────┬─────────────┘                                                │
│              │ NO                                                           │
│              ▼                                                              │
│  ┌─────────────────────────┐                                                │
│  │ Transition to VALIDATE  │                                                │
│  └─────────────────────────┘                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Completion Decision

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   COMPLETION CHECK                                           │
│                                                                             │
│  PR MERGED                                                                  │
│    │                                                                        │
│    ▼                                                                        │
│  ┌─────────────────────────┐                                                │
│  │ All stages complete?    │                                                │
│  │ (all status=complete)   │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│    ┌─────────┴─────────┐                                                    │
│    ▼                   ▼                                                    │
│   YES                  NO                                                   │
│    │                   │                                                    │
│    │                   ▼                                                    │
│    │         ┌─────────────────────────┐                                    │
│    │         │ ERROR: Invalid state    │                                    │
│    │         │ (should not happen)     │                                    │
│    │         └─────────────────────────┘                                    │
│    ▼                                                                        │
│  ┌─────────────────────────┐                                                │
│  │ Update system-queue     │                                                │
│  │ status = "complete"     │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│              ▼                                                              │
│  ┌─────────────────────────┐                                                │
│  │ Create completion       │                                                │
│  │ handoff document        │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│              ▼                                                              │
│  ┌─────────────────────────┐                                                │
│  │ Clean up worktree       │                                                │
│  │ Archive loop-state      │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│              ▼                                                              │
│  ┌─────────────────────────┐                                                │
│  │ Check for next system   │                                                │
│  │ in queue                │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                              │
│    ┌─────────┴─────────┐                                                    │
│    ▼                   ▼                                                    │
│  FOUND              NONE                                                    │
│    │                   │                                                    │
│    ▼                   ▼                                                    │
│  ┌───────────────┐  ┌───────────────────┐                                   │
│  │ Start next    │  │ Domain progress   │                                   │
│  │ system        │  │ report: X% done   │                                   │
│  └───────────────┘  └───────────────────┘                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```
